<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compendium | Issolas</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown Editor -->
    <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDv7iAlojLPMLBMQ1ZflNzk92n15H4Injs",
          authDomain: "issolas-9bbe1.firebaseapp.com",
          projectId: "issolas-9bbe1",
          storageBucket: "issolas-9bbe1.firebasestorage.app",
          messagingSenderId: "959555555353",
          appId: "1:959555555353:web:181c1eea7cc616dc029a88",
          measurementId: "G-9KFVYB46VK"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const X = ({ className }) => {
            React.useEffect(() => {
                lucide.createIcons();
            });
            return <i data-lucide="x" className={className}></i>;
        };
        
        const MapPin = ({ className }) => {
            React.useEffect(() => {
                lucide.createIcons();
            });
            return <i data-lucide="map-pin" className={className}></i>;
        };

        const Skull = ({ className }) => {
            React.useEffect(() => {
                lucide.createIcons();
            });
            return <i data-lucide="skull" className={className}></i>;
        };

        // =============================================
        // LOGIN SCREEN
        // =============================================
        const LoginScreen = ({ onLogin, error }) => (
            <div className="min-h-screen bg-gradient-to-br from-amber-50 via-stone-100 to-amber-100 flex items-center justify-center">
                <div className="bg-white bg-opacity-90 rounded-lg shadow-2xl p-8 max-w-md w-full mx-4" style={{ 
                    border: '4px solid #8b7355',
                    boxShadow: '0 0 0 2px #d4af37, 0 0 0 6px #8b7355, 0 20px 60px rgba(0, 0, 0, 0.3)'
                }}>
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-amber-900 mb-2" style={{ fontFamily: 'Cinzel, serif' }}>Issolas</h1>
                        <h2 className="text-2xl text-amber-800" style={{ fontFamily: 'Cinzel, serif' }}>Compendium</h2>
                        <div className="flex items-center gap-3 mt-4">
                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                            <div className="text-amber-600">◆</div>
                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                        </div>
                    </div>
                    <p className="text-center text-amber-800 mb-6" style={{ fontFamily: 'Crimson Text, serif' }}>
                        Sign in to access your adventure notes and the world compendium.
                    </p>
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-center" style={{ fontFamily: 'Crimson Text, serif' }}>
                            {error}
                        </div>
                    )}
                    <button onClick={onLogin} className="w-full flex items-center justify-center gap-3 px-6 py-3 bg-white border-2 border-amber-600 rounded-lg hover:bg-amber-50 transition-all duration-200 shadow-md hover:shadow-lg" style={{ fontFamily: 'Crimson Text, serif' }}>
                        <svg className="w-6 h-6" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span className="text-lg text-gray-700">Sign in with Google</span>
                    </button>
                    <p className="text-center text-amber-600 text-sm mt-6" style={{ fontFamily: 'Crimson Text, serif' }}>
                        Only those worthy may enter.
                    </p>
                </div>
            </div>
        );

        // =============================================
        // ACCESS PENDING SCREEN
        // =============================================
        const AccessPendingScreen = ({ user, onLogout }) => (
            <div className="min-h-screen bg-gradient-to-br from-amber-50 via-stone-100 to-amber-100 flex items-center justify-center">
                <div className="bg-white bg-opacity-90 rounded-lg shadow-2xl p-8 max-w-md w-full mx-4 text-center" style={{ 
                    border: '4px solid #8b7355',
                    boxShadow: '0 0 0 2px #d4af37, 0 0 0 6px #8b7355, 0 20px 60px rgba(0, 0, 0, 0.3)'
                }}>
                    <h1 className="text-3xl font-bold text-amber-900 mb-4" style={{ fontFamily: 'Cinzel, serif' }}>Access Pending</h1>
                    <div className="flex items-center gap-3 mb-6">
                        <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                        <div className="text-amber-600">◆</div>
                        <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                    </div>
                    <p className="text-amber-800 mb-4" style={{ fontFamily: 'Crimson Text, serif' }}>
                        Welcome, <strong>{user.displayName || user.email}</strong>
                    </p>
                    <p className="text-amber-700 mb-6" style={{ fontFamily: 'Crimson Text, serif' }}>
                        Your account is awaiting approval from the Dungeon Master.
                    </p>
                    <button onClick={onLogout} className="px-6 py-2 bg-amber-100 border-2 border-amber-600 rounded-lg hover:bg-amber-200 transition-all" style={{ fontFamily: 'Crimson Text, serif' }}>
                        Sign Out
                    </button>
                </div>
            </div>
        );

        // =============================================
        // LOADING SCREEN
        // =============================================
        const LoadingScreen = () => (
            <div className="min-h-screen bg-gradient-to-br from-amber-50 via-stone-100 to-amber-100 flex items-center justify-center">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-16 w-16 border-4 border-amber-300 border-t-amber-600 mx-auto mb-4"></div>
                    <p className="text-amber-800 text-xl" style={{ fontFamily: 'Cinzel, serif' }}>Loading...</p>
                </div>
            </div>
        );

        // =============================================
        // MAIN APP WITH AUTH
        // =============================================
        const App = () => {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            // Listen for auth state changes
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
                    setUser(firebaseUser);
                    if (!firebaseUser) {
                        setUserRole(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Real-time listener for user role (updates immediately when changed in Firebase)
            useEffect(() => {
                if (!user) {
                    setLoading(false);
                    return;
                }
                
                const unsubscribe = db.collection('userRoles').doc(user.uid)
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            setUserRole(doc.data().role);
                        } else {
                            setUserRole(null);
                        }
                        setLoading(false);
                    }, (error) => {
                        console.error('Error listening to user role:', error);
                        setUserRole(null);
                        setLoading(false);
                    });
                
                return () => unsubscribe();
            }, [user]);

            const handleLogin = async () => {
                try {
                    setAuthError(null);
                    await auth.signInWithPopup(googleProvider);
                } catch (error) {
                    console.error('Login error:', error);
                    setAuthError('Failed to sign in. Please try again.');
                }
            };

            const handleLogout = async () => {
                try { await auth.signOut(); } catch (error) { console.error('Logout error:', error); }
            };

            if (loading) return <LoadingScreen />;
            if (!user) return <LoginScreen onLogin={handleLogin} error={authError} />;
            if (!userRole) return <AccessPendingScreen user={user} onLogout={handleLogout} />;
            return <DnDInteractiveMap user={user} userRole={userRole} onLogout={handleLogout} />;
        };

        const DnDInteractiveMap = ({ user, userRole, onLogout }) => {
          const [selectedLocation, setSelectedLocation] = useState(null);
          const [hoveredNode, setHoveredNode] = useState(null);
          const [currentMap, setCurrentMap] = useState('world-overview');
          const [activeTab, setActiveTab] = useState('cartographer');
          const [activeCodexSection, setActiveCodexSection] = useState('lore');
          const [activeFieldGuideTab, setActiveFieldGuideTab] = useState('flora');
          const [noteCards, setNoteCards] = useState([]);
          const [folders, setFolders] = useState([]);
          const [notesLoading, setNotesLoading] = useState(true);
          const [selectedFolder, setSelectedFolder] = useState(null);
          const [isCreatingFolder, setIsCreatingFolder] = useState(false);
          const [newFolderName, setNewFolderName] = useState('');
          const [newFolderColor, setNewFolderColor] = useState('#d4af37');
          const [editingFolderId, setEditingFolderId] = useState(null);
          const [editingFolderName, setEditingFolderName] = useState('');
          const [isCreatingNote, setIsCreatingNote] = useState(false);
          const [currentNote, setCurrentNote] = useState({ title: '', content: '', folderId: null });
          const [editingNoteId, setEditingNoteId] = useState(null);
          const [draggedNote, setDraggedNote] = useState(null);
          const [mapTimeOfDay, setMapTimeOfDay] = useState('day');
          const [selectedLore, setSelectedLore] = useState(null);
          const [noteSearchQuery, setNoteSearchQuery] = useState('');
          const [expandedNote, setExpandedNote] = useState(null);
          const [autoSaveStatus, setAutoSaveStatus] = useState(null);
          const [noteSortOrder, setNoteSortOrder] = useState('manual');
          const [noteOrder, setNoteOrder] = useState([]);
          const [dragOverNoteId, setDragOverNoteId] = useState(null);
          const [nodesVisible, setNodesVisible] = useState(false);
          const [fieldGuideSearch, setFieldGuideSearch] = useState('');
          const [fieldGuideRarityFilter, setFieldGuideRarityFilter] = useState('all');
          const [fieldGuideHabitatFilter, setFieldGuideHabitatFilter] = useState('all');
          const [movingNoteId, setMovingNoteId] = useState(null);
          const editorRef = React.useRef(null);
          const editorContainerRef = React.useRef(null);
          const easyMDERef = React.useRef(null);
          const autoSaveTimeoutRef = React.useRef(null);

          // Escape key handler to close modals/windows
          useEffect(() => {
            const handleEscapeKey = (e) => {
              if (e.key === 'Escape') {
                if (selectedLore) setSelectedLore(null);
                else if (expandedNote) setExpandedNote(null);
                else if (selectedLocation) setSelectedLocation(null);
                else if (isCreatingNote) {
                  setIsCreatingNote(false);
                  setCurrentNote({ title: '', content: '', folderId: null });
                  setEditingNoteId(null);
                }
              }
            };
            document.addEventListener('keydown', handleEscapeKey);
            return () => document.removeEventListener('keydown', handleEscapeKey);
          }, [selectedLore, expandedNote, selectedLocation, isCreatingNote]);

          // Close all modals and editors when switching tabs
          const closeAllModals = () => {
            setSelectedLocation(null);
            setSelectedLore(null);
            setExpandedNote(null);
            setFieldGuideSearch('');
            setFieldGuideRarityFilter('all');
            setFieldGuideHabitatFilter('all');
            if (isCreatingNote) {
              setIsCreatingNote(false);
              setCurrentNote({ title: '', content: '', folderId: null });
              setEditingNoteId(null);
              setAutoSaveStatus(null);
            }
          };

          // Trigger node animation when map changes or tab switches to cartographer
          useEffect(() => {
            setNodesVisible(false);
            if (activeTab === 'cartographer') {
              const timer = setTimeout(() => {
                setNodesVisible(true);
              }, 500);
              return () => clearTimeout(timer);
            }
          }, [currentMap, activeTab]);

          // Firebase sync for notes and folders
          useEffect(() => {
            if (!user) return;
            const notesUnsub = db.collection('users').doc(user.uid).collection('notes')
              .orderBy('createdAt', 'desc')
              .onSnapshot((snap) => {
                setNoteCards(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                setNotesLoading(false);
              }, (err) => { console.error('Notes error:', err); setNotesLoading(false); });
            const foldersUnsub = db.collection('users').doc(user.uid).collection('folders')
              .orderBy('createdAt', 'asc')
              .onSnapshot((snap) => {
                setFolders(snap.docs.map(d => ({ id: d.id, ...d.data() })));
              }, (err) => console.error('Folders error:', err));
            return () => { notesUnsub(); foldersUnsub(); };
          }, [user]);

          // Auto-save function
          const autoSaveNote = async (title, content, folderId) => {
            if (!user || !editingNoteId) return;
            setAutoSaveStatus('saving');
            try {
              await db.collection('users').doc(user.uid).collection('notes').doc(editingNoteId).update({
                title, content, folderId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              setAutoSaveStatus('saved');
              setTimeout(() => setAutoSaveStatus(null), 2000);
            } catch (e) { 
              console.error('Auto-save error:', e); 
              setAutoSaveStatus(null);
            }
          };

          // Debounced auto-save
          const scheduleAutoSave = (title, content, folderId) => {
            setAutoSaveStatus('saving');
            if (autoSaveTimeoutRef.current) {
              clearTimeout(autoSaveTimeoutRef.current);
            }
            autoSaveTimeoutRef.current = setTimeout(() => {
              autoSaveNote(title, content, folderId);
            }, 1000);
          };

          // EasyMDE Editor setup
          useEffect(() => {
            if (isCreatingNote && editorContainerRef.current && !easyMDERef.current) {
              setTimeout(() => {
                if (editorContainerRef.current && !easyMDERef.current) {
                  easyMDERef.current = new EasyMDE({
                    element: editorContainerRef.current,
                    initialValue: currentNote.content || '',
                    spellChecker: false,
                    autofocus: true,
                    placeholder: 'Write your notes in Markdown...',
                    status: ['lines', 'words'],
                    toolbar: [
                      'bold', 'italic', 'strikethrough', 'heading', '|',
                      'quote', 'unordered-list', 'ordered-list', '|',
                      'link', 'image', 'table', 'horizontal-rule', '|',
                      'preview', 'side-by-side', '|',
                      'guide'
                    ],
                    minHeight: '300px',
                    sideBySideFullscreen: false,
                  });
                  
                  easyMDERef.current.codemirror.on('change', () => {
                    const content = easyMDERef.current.value();
                    setCurrentNote(prev => ({ ...prev, content }));
                    if (editingNoteId) {
                      scheduleAutoSave(currentNote.title, content, currentNote.folderId);
                    }
                  });
                }
              }, 50);
            }
            
            if (!isCreatingNote && easyMDERef.current) {
              if (autoSaveTimeoutRef.current) {
                clearTimeout(autoSaveTimeoutRef.current);
              }
              easyMDERef.current.toTextArea();
              easyMDERef.current = null;
            }
          }, [isCreatingNote]);

          useEffect(() => {
            if (isCreatingNote && easyMDERef.current && editingNoteId) {
              easyMDERef.current.value(currentNote.content || '');
            }
          }, [editingNoteId]);

          // Render markdown to HTML
          const renderMarkdown = (content) => {
            if (!content) return '';
            try { return marked.parse(content); } catch (e) { return content; }
          };

          const createNewNote = () => {
            setCurrentNote({ title: '', content: '', folderId: selectedFolder });
            setEditingNoteId(null);
            setIsCreatingNote(true);
          };

          // Search/filter notes
          const filteredNotes = noteCards.filter(note => {
            const matchesFolder = selectedFolder === null || note.folderId === selectedFolder;
            if (!noteSearchQuery.trim()) return matchesFolder;
            const query = noteSearchQuery.toLowerCase();
            const titleMatch = (note.title || '').toLowerCase().includes(query);
            const contentMatch = (note.content || '').toLowerCase().includes(query);
            return matchesFolder && (titleMatch || contentMatch);
          });

          // Sort notes
          const sortedNotes = React.useMemo(() => {
            let sorted = [...filteredNotes];
            switch (noteSortOrder) {
              case 'alphabetical':
                sorted.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                break;
              case 'lastEdited':
                sorted.sort((a, b) => {
                  const aTime = a.updatedAt?.toDate?.() || new Date(0);
                  const bTime = b.updatedAt?.toDate?.() || new Date(0);
                  return bTime - aTime;
                });
                break;
              case 'manual':
                if (noteOrder.length > 0) {
                  sorted.sort((a, b) => {
                    const aIndex = noteOrder.indexOf(a.id);
                    const bIndex = noteOrder.indexOf(b.id);
                    if (aIndex === -1 && bIndex === -1) return 0;
                    if (aIndex === -1) return 1;
                    if (bIndex === -1) return -1;
                    return aIndex - bIndex;
                  });
                }
                break;
            }
            return sorted;
          }, [filteredNotes, noteSortOrder, noteOrder]);

          // Highlight search matches
          const highlightSearchMatch = (text, isHtml = false) => {
            if (!noteSearchQuery.trim() || !text) return text;
            const query = noteSearchQuery.toLowerCase();
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
          };

          // Field guide filtering and searching
          const filterFieldGuideEntries = (entries) => {
            if (!entries) return [];
            return entries.filter(entry => {
              // Search filter
              if (fieldGuideSearch.trim()) {
                const query = fieldGuideSearch.toLowerCase();
                const nameMatch = entry.name.toLowerCase().includes(query);
                const descMatch = entry.description.toLowerCase().includes(query);
                const habitatMatch = entry.habitat.toLowerCase().includes(query);
                if (!nameMatch && !descMatch && !habitatMatch) return false;
              }
              // Rarity filter
              if (fieldGuideRarityFilter !== 'all') {
                if (entry.rarity.toLowerCase().replace(' ', '-') !== fieldGuideRarityFilter) return false;
              }
              // Habitat filter
              if (fieldGuideHabitatFilter !== 'all') {
                if (!entry.habitat.toLowerCase().includes(fieldGuideHabitatFilter.toLowerCase())) return false;
              }
              return true;
            });
          };

          // Get unique habitats from field guide
          const getUniqueHabitats = (fieldGuide) => {
            if (!fieldGuide) return [];
            const habitats = new Set();
            [...(fieldGuide.flora || []), ...(fieldGuide.fauna || [])].forEach(entry => {
              entry.habitat.split(', ').forEach(h => habitats.add(h.trim()));
            });
            return Array.from(habitats).sort();
          };

          // Highlight field guide search matches
          const highlightFieldGuideMatch = (text) => {
            if (!fieldGuideSearch.trim() || !text) return text;
            const query = fieldGuideSearch.toLowerCase();
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="search-highlight">$1</mark>');
          };

          // Get rarity icon and color
          const getRarityInfo = (rarity) => {
            switch (rarity.toLowerCase()) {
              case 'common': return { icon: '●', color: '#4a6741', borderColor: '#4a6741' };
              case 'uncommon': return { icon: '◆', color: '#2563eb', borderColor: '#2563eb' };
              case 'rare': return { icon: '★', color: '#9333ea', borderColor: '#9333ea' };
              case 'very rare': return { icon: '✦', color: '#ea580c', borderColor: '#ea580c' };
              default: return { icon: '●', color: '#4a6741', borderColor: '#4a6741' };
            }
          };

          // Handle note reordering (works in ALL sort modes)
          const handleNoteDragOver = (e, noteId) => {
            e.preventDefault();
            if (draggedNote && draggedNote !== noteId) {
              setDragOverNoteId(noteId);
            }
          };

          const handleNoteDrop = (e, targetNoteId) => {
            e.preventDefault();
            setDragOverNoteId(null);
            if (!draggedNote || draggedNote === targetNoteId) return;
            
            // Always use current sorted order as base
            const currentOrder = sortedNotes.map(n => n.id);
            const draggedIndex = currentOrder.indexOf(draggedNote);
            const targetIndex = currentOrder.indexOf(targetNoteId);
            
            if (draggedIndex !== -1) {
              currentOrder.splice(draggedIndex, 1);
            }
            if (targetIndex !== -1) {
              currentOrder.splice(targetIndex, 0, draggedNote);
            } else {
              currentOrder.push(draggedNote);
            }
            
            setNoteOrder(currentOrder);
            setNoteSortOrder('manual'); // Switch to manual after drag
            setDraggedNote(null);
          };

          // Mobile move functions
          const moveNoteUp = (noteId) => {
            const currentOrder = sortedNotes.map(n => n.id);
            const index = currentOrder.indexOf(noteId);
            if (index > 0) {
              [currentOrder[index], currentOrder[index - 1]] = [currentOrder[index - 1], currentOrder[index]];
              setNoteOrder(currentOrder);
              setNoteSortOrder('manual');
            }
          };

          const moveNoteDown = (noteId) => {
            const currentOrder = sortedNotes.map(n => n.id);
            const index = currentOrder.indexOf(noteId);
            if (index < currentOrder.length - 1) {
              [currentOrder[index], currentOrder[index + 1]] = [currentOrder[index + 1], currentOrder[index]];
              setNoteOrder(currentOrder);
              setNoteSortOrder('manual');
            }
          };

          const createFolder = async () => {
            if (newFolderName.trim() && user) {
              try {
                await db.collection('users').doc(user.uid).collection('folders').add({
                  name: newFolderName, color: newFolderColor,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                setNewFolderName(''); setNewFolderColor('#d4af37'); setIsCreatingFolder(false);
              } catch (e) { console.error('Create folder error:', e); }
            }
          };

          const deleteFolder = async (id) => {
            if (window.confirm('Delete this folder? Notes inside will not be deleted.')) {
              try {
                await db.collection('users').doc(user.uid).collection('folders').doc(id).delete();
                // Update local state immediately
                setFolders(prev => prev.filter(folder => folder.id !== id));
                if (selectedFolder === id) setSelectedFolder(null);
              } catch (e) { console.error('Delete folder error:', e); }
            }
          };

          const renameFolder = async (id, newName) => {
            if (newName.trim()) {
              try {
                await db.collection('users').doc(user.uid).collection('folders').doc(id).update({ name: newName });
                setEditingFolderId(null); setEditingFolderName('');
              } catch (e) { console.error('Rename folder error:', e); }
            }
          };

          const moveNoteToFolder = async (noteId, folderId) => {
            try {
              await db.collection('users').doc(user.uid).collection('notes').doc(noteId).update({ folderId });
            } catch (e) { console.error('Move note error:', e); }
          };

          const saveNote = async () => {
            try {
              if (editingNoteId !== null) {
                await db.collection('users').doc(user.uid).collection('notes').doc(editingNoteId).update({
                  title: currentNote.title, content: currentNote.content, folderId: currentNote.folderId,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              } else {
                await db.collection('users').doc(user.uid).collection('notes').add({
                  title: currentNote.title, content: currentNote.content, folderId: currentNote.folderId,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              setIsCreatingNote(false); setCurrentNote({ title: '', content: '', folderId: null }); setEditingNoteId(null);
            } catch (e) { console.error('Save note error:', e); }
          };

          const editNote = (note) => {
            setCurrentNote({ title: note.title, content: note.content, folderId: note.folderId || null });
            setEditingNoteId(note.id);
            setIsCreatingNote(true);
          };

          const deleteNote = async (id) => {
            if (window.confirm('Are you sure you want to delete this note?')) {
              try {
                await db.collection('users').doc(user.uid).collection('notes').doc(id).delete();
                setNoteCards(prev => prev.filter(note => note.id !== id));
                if (expandedNote && expandedNote.id === id) {
                  setExpandedNote(null);
                }
              } catch (e) { console.error('Delete note error:', e); }
            }
          };

          const applyFormat = (command, value = null) => {
            editorRef.current?.focus();
            document.execCommand(command, false, value);
          };

          const insertList = (type) => {
            editorRef.current?.focus();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            let listElement = range.startContainer;
            while (listElement && listElement !== editorRef.current) {
              if (listElement.tagName === 'UL' || listElement.tagName === 'OL') break;
              listElement = listElement.parentElement;
            }
            if (!listElement || listElement === editorRef.current || editorRef.current.innerHTML.trim() === '') {
              const listTag = type === 'bullet' ? 'ul' : 'ol';
              const newList = document.createElement(listTag);
              const styleType = type === 'bullet' ? currentBulletStyle : currentNumberStyle;
              newList.style.listStyleType = styleType;
              const listItem = document.createElement('li');
              listItem.innerHTML = '<br>';
              newList.appendChild(listItem);
              if (editorRef.current.innerHTML.trim() === '') {
                editorRef.current.innerHTML = '';
              }
              editorRef.current.appendChild(newList);
              const newRange = document.createRange();
              newRange.setStart(listItem, 0);
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
            } else {
              document.execCommand(type === 'bullet' ? 'insertUnorderedList' : 'insertOrderedList', false, null);
              setTimeout(() => {
                const styleType = type === 'bullet' ? currentBulletStyle : currentNumberStyle;
                changeListStyle(styleType);
              }, 0);
            }
            handleEditorInput({ currentTarget: editorRef.current });
          };

          const changeListStyle = (styleType) => {
            editorRef.current?.focus();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            let listElement = selection.anchorNode;
            while (listElement && listElement !== editorRef.current) {
              if (listElement.tagName === 'UL' || listElement.tagName === 'OL') {
                listElement.style.listStyleType = styleType;
                break;
              }
              listElement = listElement.parentElement;
            }
            handleEditorInput({ currentTarget: editorRef.current });
          };

          const handleEditorInput = (e) => {
            setCurrentNote({...currentNote, content: e.currentTarget.innerHTML});
          };

          const handleKeyDown = (e) => {
            if (e.key === 'Tab') {
              e.preventDefault();
              e.stopPropagation();
              const selection = window.getSelection();
              if (!selection.rangeCount) return;
              let listItem = null;
              let node = selection.anchorNode;
              for (let i = 0; i < 10 && node && node !== editorRef.current; i++) {
                if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'LI') {
                  listItem = node;
                  break;
                }
                node = node.parentNode;
              }
              if (!listItem) return;
              const parentList = listItem.parentElement;
              if (!parentList || (parentList.tagName !== 'UL' && parentList.tagName !== 'OL')) return;
              const isOrdered = parentList.tagName === 'OL';
              if (e.shiftKey) {
                const grandparentLI = parentList.closest('li');
                if (grandparentLI) {
                  const grandparentList = grandparentLI.parentElement;
                  grandparentList.insertBefore(listItem, grandparentLI.nextSibling);
                  if (parentList.children.length === 0) parentList.remove();
                  handleEditorInput({ currentTarget: editorRef.current });
                }
              } else {
                const previousSibling = listItem.previousElementSibling;
                if (previousSibling && previousSibling.tagName === 'LI') {
                  let nestedList = null;
                  for (let child of previousSibling.children) {
                    if (child.tagName === 'UL' || child.tagName === 'OL') {
                      nestedList = child;
                      break;
                    }
                  }
                  if (!nestedList) {
                    nestedList = document.createElement(parentList.tagName);
                    const depth = getListDepth(previousSibling) + 1;
                    const style = getListStyleForDepth(depth, isOrdered);
                    nestedList.style.listStyleType = style;
                    previousSibling.appendChild(nestedList);
                  }
                  const range = selection.getRangeAt(0);
                  const cursorOffset = range.startOffset;
                  const cursorNode = range.startContainer;
                  nestedList.appendChild(listItem);
                  try {
                    const newRange = document.createRange();
                    newRange.setStart(cursorNode, cursorOffset);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                  } catch (e) {
                    if (listItem.firstChild) {
                      const newRange = document.createRange();
                      newRange.setStart(listItem.firstChild, 0);
                      newRange.collapse(true);
                      selection.removeAllRanges();
                      selection.addRange(newRange);
                    }
                  }
                  handleEditorInput({ currentTarget: editorRef.current });
                }
              }
              return;
            }
            if (e.key === 'Backspace') {
              const selection = window.getSelection();
              if (!selection.rangeCount) return;
              const range = selection.getRangeAt(0);
              let listItem = selection.anchorNode;
              while (listItem && listItem !== editorRef.current) {
                if (listItem.tagName === 'LI') break;
                listItem = listItem.parentElement;
              }
              if (listItem && listItem.tagName === 'LI') {
                const isAtStart = range.startOffset === 0 && 
                                  (range.startContainer === listItem || range.startContainer === listItem.firstChild);
                if (isAtStart) {
                  e.preventDefault();
                  const parentList = listItem.parentElement;
                  const isNested = parentList.parentElement?.closest('li');
                  if (isNested) {
                    const grandparentList = parentList.parentElement?.closest('ul, ol');
                    if (grandparentList) {
                      const parentListItem = parentList.closest('li');
                      grandparentList.insertBefore(listItem, parentListItem.nextSibling);
                    }
                  } else {
                    if (listItem.textContent.trim() === '') {
                      const paragraph = document.createElement('p');
                      paragraph.innerHTML = '<br>';
                      parentList.parentNode.insertBefore(paragraph, parentList);
                      listItem.remove();
                      if (parentList.children.length === 0) parentList.remove();
                      const newRange = document.createRange();
                      newRange.setStart(paragraph, 0);
                      newRange.collapse(true);
                      selection.removeAllRanges();
                      selection.addRange(newRange);
                    } else {
                      const paragraph = document.createElement('p');
                      paragraph.innerHTML = listItem.innerHTML;
                      parentList.parentNode.insertBefore(paragraph, parentList);
                      listItem.remove();
                      if (parentList.children.length === 0) parentList.remove();
                      const newRange = document.createRange();
                      newRange.setStart(paragraph.firstChild, 0);
                      newRange.collapse(true);
                      selection.removeAllRanges();
                      selection.addRange(newRange);
                    }
                  }
                  handleEditorInput({ currentTarget: editorRef.current });
                  return;
                }
              }
            }
            if (e.key === 'Enter') {
              const selection = window.getSelection();
              if (!selection.rangeCount) return;
              let listItem = selection.anchorNode;
              while (listItem && listItem !== editorRef.current) {
                if (listItem.tagName === 'LI') {
                  const textContent = listItem.textContent.trim();
                  const hasNestedList = listItem.querySelector('ul, ol');
                  if (textContent === '' && !hasNestedList) {
                    e.preventDefault();
                    const parentList = listItem.parentElement;
                    const isNested = parentList.parentElement?.closest('li');
                    if (isNested) {
                      const grandparentList = parentList.parentElement?.closest('ul, ol');
                      if (grandparentList) {
                        const parentListItem = parentList.closest('li');
                        const newItem = document.createElement('li');
                        newItem.innerHTML = '<br>';
                        grandparentList.insertBefore(newItem, parentListItem.nextSibling);
                        listItem.remove();
                        if (parentList.children.length === 0) parentList.remove();
                        const range = document.createRange();
                        range.setStart(newItem, 0);
                        range.collapse(true);
                        selection.removeAllRanges();
                        selection.addRange(range);
                      }
                    } else {
                      listItem.remove();
                      const newPara = document.createElement('p');
                      newPara.innerHTML = '<br>';
                      parentList.parentNode.insertBefore(newPara, parentList.nextSibling);
                      if (parentList.children.length === 0) parentList.remove();
                      const range = document.createRange();
                      range.setStart(newPara, 0);
                      range.collapse(true);
                      selection.removeAllRanges();
                      selection.addRange(range);
                    }
                    handleEditorInput({ currentTarget: editorRef.current });
                    return;
                  }
                  return;
                }
                listItem = listItem.parentElement;
              }
            }
          };
          
          const getListDepth = (element) => {
            let depth = 0;
            let current = element;
            while (current && current !== editorRef.current) {
              if (current.tagName === 'UL' || current.tagName === 'OL') depth++;
              current = current.parentElement;
            }
            return depth;
          };
          
          const getListStyleForDepth = (depth, isOrdered) => {
            if (isOrdered) {
              const styles = ['decimal', 'lower-alpha', 'lower-roman', 'decimal'];
              return styles[(depth - 1) % styles.length];
            } else {
              const styles = ['disc', 'circle', 'square', 'disc'];
              return styles[(depth - 1) % styles.length];
            }
          };

          const mapRegions = [
            { id: 'world-overview', name: 'World Overview', category: 'Issolas', image: 'world_maps/world_map.png', dmImage: 'world_maps/world_map_2.png', roles: ['dm', 'adventurer'] },
            { id: 'sirens-song', name: "Siren's Song", category: 'Issolas', image: 'sirens_song_maps/sirens_song_map.png', roles: ['dm', 'adventurer'] },
            { id: 'miligos', name: 'Miligos', category: 'Issolas', image: 'miligos_maps/miligos.png', roles: ['dm'] }
          ];

          // Get the appropriate map image based on role
          const getMapImage = (mapData) => {
            if (mapData.dmImage && userRole === 'dm') {
              return mapData.dmImage;
            }
            return mapData.image;
          };

          // Filter maps by role
          const visibleMapRegions = mapRegions.filter(region => region.roles.includes(userRole));
          
          const activeMapData = mapRegions.find(map => map.id === currentMap);
          
          // Check if user has access to current map, redirect if not
          React.useEffect(() => {
            if (activeMapData && !activeMapData.roles.includes(userRole)) {
              setCurrentMap('sirens-song');
            }
          }, [userRole, currentMap]);

          // Check if user can access field guide for a specific location
          const canAccessFieldGuide = (location) => {
            const allowedRoles = location?.fieldGuideRoles || ['dm'];
            return allowedRoles.includes(userRole);
          };

          const codexData = {
            lore: [
              { 
                title: "The Calamity", 
                summary: "The first blood ever spilled on Issolas - and the unmaking that followed.",
                narrative: `On a night the records describe only as moonless - though I wonder if the moon was truly absent or simply refusing to witness - she moved through corridors that seemed to cooperate with her silence. Her hands carried a sharpened bedpost.

Her sister slept beyond the chamber door.

Merida. The chosen. The image of Paladia's pride. I have found no physical descriptions of Merida, which strikes me as significant. She exists in the records only as a category: perfect, beloved, unblemished by doubt. Perhaps she was never a person at all. Perhaps she was a function. A role the city required someone to perform.

Eridana looked at her sleeping sister, and what she felt was not tenderness.

The records use the word revulsion, but I suspect this, too, is imprecise. What Eridana felt, I believe, was recognition - the unbearable recognition of something that had successfully become what she could not. The stake descended. Paradise began to leak.

The first blood ever spilled on Issolas.

Consider what that means. A world with no history of violence. A world where blood had never touched soil. The ecosystem was unprepared. The earth was unprepared. The very air was unprepared.

The blood did not remain blood for long.

It spread - not outward but through, permeating the ground, the atmosphere, the fundamental structure of what Issolas was. An unmaking. The kind of contamination that doesn't poison a system so much as rewrite its operating principles.

The Six noticed.

Their response came not as light, not as fire, but as a fissure - a shriek in the world's skin, a wound that opened from nowhere and led to nowhere. Paladia shattered. Its towers sublimated into ash that moved with deliberate patterns, forming shapes that almost resembled constellations before dispersing into randomness. Or what we call randomness, lacking the organs to perceive the order.

The continent split. The world cracked open like an egg containing something that had outgrown it.

In the ruin, the gods left a single fragment - the Aetherfall.`
              },
              { 
                title: "The Aetherfall", 
                summary: "A pillar of black glass rising from the wound, bearing words that resist understanding.",
                narrative: `A pillar of black glass, later called the Aetherfall, rising from the wound. On its surface, carved in letters that seemed to shift when observed directly, four words:

Light forgets faith forgotten

I have spent considerable time with this phrase. Its grammar resists parsing. Light forgets: light as agent, light as something capable of memory and therefore capable of its loss. Faith forgotten: forgotten by whom? By the light? By those who held it? The sentence structure suggests that light's forgetting and faith's being forgotten are the same event, or perhaps the same substance differently expressed.

The Aetherfall glowed with what survivors described as "the residue of fury." An obsidian truth. A meaning that demanded interpretation while actively resisting it.

Centuries passed.

I use that phrase loosely. Time moved differently in the aftermath, according to the fragmentary records. Some regions experienced years in what others experienced as weeks. Some places stopped experiencing time altogether and had to be avoided, their inhabitants frozen in postures of flight or prayer.

But eventually, a pattern emerged. Two realms, growing like scar tissue around a wound.

To the West: those who still trembled before the Six. They built shrines of ash and bone. Their rituals were not celebrations but apologies, extended across generations, a hereditary prostration before silence. They called themselves the Faithful, though faith seems inadequate to describe what drove them. Fear, perhaps. Or habit. Or the suspicion that stopping would be worse.

To the East: the abandoned. They peeled away the divine mask - I find this phrase in multiple sources, always with the same unsettling precision - and looked elsewhere. To lesser gods. To voices hidden in marrow and stone. To powers that the Six had forbidden, or perhaps had never known existed. They sought vengeance not only against the absent gods but against the memory of reverence itself.

Between them lay a broken archipelago.

The fog around those islands is not natural fog. This becomes clear after even brief exposure. It moves against wind patterns. It responds to observation. Sailors who ventured into it reported that the mist seemed to contain shapes - vast structures barely visible, like cathedrals glimpsed through frosted glass - that rearranged themselves when attention shifted.

The islands themselves were jagged as teeth. The reefs between them moved. Not drifted: moved. Deliberate rearrangements that seemed designed to cause exactly the shipwrecks that occurred.

At the center of this aquatic maze stood the ruin of what had once been Paladia's Highcastle. And there, unchanged after centuries of exposure to salt and wind and that terrible, thinking fog: the Aetherfall.

Black. Implacable. Radiating a silence that seemed to grow heavier the longer one remained near it.

Many went to it. The records are clear on this.

None returned whole. Most did not return at all.

Rumor holds - and here I must acknowledge that rumor is the only source remaining for certain claims - that the carvings on the Aetherfall are not singular.

That beneath "Light forgets faith forgotten" sleeps another phrase, carved in an older tongue. Older than the Six. Older than Issolas. Perhaps older than the concept of inscription itself.

Some say this hidden language could repair the sundered world. Others say it could restore the favor of the gods. Still others - and these are the accounts that unsettle me most - suggest it could unmake the Six entirely. Not kill them. Unmake them. Retroactively erase the fact of their existence.

In taverns where hearths burn too low, travelers trade fragments of stories about those who vanished into the fog. Their last words, reportedly, muttered of shapes carved deeper into the stone. A second text. A buried grammar. A meaning beneath.`
              }
            ],
            pantheon: {
              theSix: [
                { name: "Paladine", title: "God of rulers and guardians", description: "Paladine the Platinum Dragon, is the draconic god of good dragons, the north wind and wisdom from the Draconic pantheon. Paladine is the embodiment of all that is good and great. He is the glorious and resplendent lord of good dragons who watches over and encourages his faithful, and serves as a bright and shining paragon of good in opposition to his bitter and twisted sister, Tiamat, the Chromatic Dragon.", domains: "Knowledge, Life", symbol: "Silver triangle", image: 'pantheon_icons/silver_triangle.png' },
                { name: "Milil", title: "God of poetry and song", description: "Milil is the god of poetry, eloquence, and song. He is a god of creativity and inspiration, of the entire song more than just the lyrics or the music. He represents the finished thought, the result of the process that takes an idea from conception to realization. He is the ideal to which all performers aspire: poised and confident, winningly charismatic, and a source of inspiration for those who listen to him.", domains: "Knowledge", symbol: "Crystal ball containing many kinds of eyes", image: 'pantheon_icons/orb_of_eyes.png' },
                { name: "Savras", title: "God of divination and fate", description: "Savras is the god of divination and fate, an aloof and inscrutable power who embodies the act of seeing beyond the present moment. To his faithful, Savras is not a god of answers freely given, but of truths revealed through discipline, sacrifice, and insight. He is revered by seers, oracles, astrologers, and those who seek to understand the hidden patterns that govern past, present, and future.", domains: "Light", symbol: "Five-stringed harp made of leaves", image: 'pantheon_icons/leaf_harp.png' },
                { name: "Lliira", title: "Goddess of joy", description: "Lliira is the goddess of joy, celebration, freedom, and unrestrained emotion. She embodies the simple and profound truth that life is meant to be lived to the fullest, with passion and disregard for needless restraint. Where sorrow long lingers or tyranny smothers, Lliira's influence rises through laughter, dance, music, and acts of spontaneous kindness. The faith of Lliira teaches that joy is not frivolous, but sacred. Her dogma urges followers to celebrate life in all its forms and to remind others that happiness is a virtue worth defending.", domains: "Life", symbol: "Triangle of three-pointed stars", image: 'pantheon_icons/star_triangle.png' },
                { name: "Eldath", title: "Goddess of peace", description: "Eldath is the goddess of peace, calm waters, and quiet places; she is gentle and contemplative, yet stands in opposition to violence. She represents serenity born of restraint and strength found in stillness. To her followers, peace is not weakness, but a deliberate and sacred choice. Eldath's priests and druids are healers. They inhabit hidden groves, springs, and pools where all may rest without fear, and where no weapon may be drawn in anger.", domains: "Life, Nature", symbol: "Waterfall plunging into still pool", image: 'pantheon_icons/waterfall.png' },
                { name: "Sune", title: "Goddess of love and beauty", description: "Sune is the goddess of love, beauty, passion, and desire in all their forms. She celebrates all permutations of beauty observes the pursuit of pleasure as a sacred expression of life itself. To Sune and her faithful, love is a transformative force that inspires the innate faculties of the spirit, and all that is born of true passion is worthy of reverence.", domains: "Life, Light", symbol: "Face of a beautiful, red-haired woman", image: 'pantheon_icons/redheaded_woman.png' }
              ],
              lesserGods: [
                { name: "Umberlee", title: "Goddess of the sea", description: "Umberlee is the cruel and capricious goddess of the sea. She is feared rather than loved, placated through offerings by sailor's hoping to earn the sea's favor. Umberlee teaches that the sea may not be tamed, and leverages its power as a force of dominance.", domains: "Tempest", symbol: "Wave curling left and right", image: 'pantheon_icons/twin_waves.png' },
                { name: "Silvanus", title: "God of nature", description: "Silvanus is the primordial god of wild nature. He is the embodiment of the forest, its beasts, and the very cycles of life itself. He stands a stalwart guardian of the natural order, indifferent and often hostile to those who seek to tip life's balanced scales", domains: "Nature", symbol: "Oak leaf", image: 'pantheon_icons/oak_leaf.png' },
                { name: "Talos", title: "God of storms", description: "Talos is the god of storms, embodying raw, senseless devastation. He believes destruction is the truest expression of power and his clergy oft revel in the chaos he brings. He is a horrible calamity.", domains: "Tempest", symbol: "Three lightning bolts radiating from a single point", image: 'pantheon_icons/lightning_triad.png' },
                { name: "Mask", title: "God of thieves", description: "Mask is the god of shadows, deception, and theft, patron to thieves and spies. Mask excites the cunning and imaginative, pulling at the most insidious sides of mortal nature. He believes law exists only as an obstacle to the cunning, a challenge to be exploited for gain and expression of artistry.", domains: "Trickery", symbol: "Black mask", image: 'pantheon_icons/black_mask.png' },
                { name: "Bhaal", title: "God of murder", description: "Bhaal is the god of murder; death given form. He revels in the act of killing - the planning, the execution. He upholds the doctrine that murder is the ultimate expression of control. To take a life is to elevate the self, and to please Bhaal.", domains: "Death", symbol: "Skull surrounded by a ring of blood droplets", image: 'pantheon_icons/blood_skull.png' },
                { name: "Azuth", title: "God of wizards", description: "Azuth, the High One, is the god of wizards, arcana, and the disciplines of magic. He represents mastery earned through study and rigorous practice. Through discipline he managed to usurp Savras and claim dominion over the magical arts. Those who follow his path are arbiters of magical conduct, possessing both mastery in ability and restraint. ", domains: "Knowledge", symbol: "Left hand pointing upward, outlined in fire", image: 'pantheon_icons/flame_hand.png' },
                { name: "Tymora", title: "Goddess of good fortune", description: "Tymora is the rush you feel when flipping a coin. She is the surge of generosity you feel when everything is going your way. She is a fortune that favors the bold and optimistic. 'Chance', to her, is merely an opportunity to seize an otherwise fleeting moment.", domains: "Trickery", symbol: "Face-up coin", image: 'pantheon_icons/face_up_coin.png' },
                { name: "Kelemvor", title: "God of the dead", description: "Kelemvor is the solemn judge of the dead. He combs the seas of the damned, sternly parsing fear and corruption from his domain. Death is the natural continuation of a life deserving and to deny this continuity is to welcome a punishing damnation.", domains: "Death", symbol: "Upright skeletal arm holding balanced scales", image: 'pantheon_icons/scales.png' },
                { name: "Gond", title: "God of craft", description: "Gond is the god of craft, artisanship, and the arts of creation. He is the embodiment of the craftsman, the artisan. Above all is progress and process; stagnation is sin. He invites the curious mind to celebrate innovation, experimentation, and the relentless pursuit of improvement.", domains: "Knowledge", symbol: "Toothed cog with four spokes", image: 'pantheon_icons/cog.png' },
                { name: "Cyric", title: "God of lies", description: "Cyric delights in discord, madness, and strife. He is the suffering caused by broken trust and his influence spreads as quickly as a growing paranoia. His followers are dangerous and unpredictable, enforcing a dogma of chaos through falsehood.", domains: "Trickery", symbol: "White, jawless skull on black or purple sunburst", image: 'pantheon_icons/jawless_skull.png' },
                { name: "Malar", title: "God of the hunt", description: "Malar is an apex predator. He is simple, savage, and ever-hungry. Outside of the constraints of civilization, survival becomes a question of one's instinct and dominance. To seek to answer this most primitive question is to seek the guiding hand of Malar.", domains: "Nature", symbol: "Clawed paw", image: 'pantheon_icons/paw.png' },
                { name: "Shar", title: "Goddess of darkness and loss", description: "Shar is a goddess of deep complexity. She permeates the cavities of the mind, filling them with despair, loss, darkness, and the coaxing comforts of oblivion. She will offer solice through the erasure of what troubles you, lulling away your fears and memories.", domains: "Death, Trickery", symbol: "Black disk encircled with a border", image: 'pantheon_icons/black_disk.png' }
              ]
            }
          };

          const locationsByMap = {
            'world-overview': [
              {
                id: 1,
                name: "Siren's Song",
                x: 13,
                y: 20,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "Siren's Song is a neutral territory island. It is home to two cities: Falkana and Artil, as well as Mount Beala - a geothermally active mountain with a permanent Winter at its summit.",
                knownNPCs: [
                  { name: "Old Man Theodormus" },
                  { name: "Lazuli Brynn" },
                  { name: "Amethyst Brynn" },
                  { name: "Yorlan Reinholt" },
                  { name: "Vigos Ashbourne" },
                  { name: "Cassian Dawnscry" },
                  { name: "Lady Syva Marina" },
                  { name: "Lord Antioch Diwalen" },
                  { name: "Marigold Breeves" }
                ],
                history: "Siren's Song once harbored two ports at its East and South ends. The Eastern port was abandoned shortly after the Calamity due to dangerous inhabitants in the surrounding forests. The rapid rate of evolution on the island is experienced by all, but retains a mystifying origination. It is said that there are regions in the forests and mountains that experience growth at a higher acceleration than others.",
                population: { total: "~4000", races: "Humans, Elves, Dwarves, Halflings, Elementals", density: "Sparse, concentrated in coastal settlements" },
                climate: { type: "Common, Forest, Hills, Swamp, Grasslands, Mountain, Coastal, Underwater", temperature: "Variable but mostly warm", precipitation: "Large amount of annual rainfall", seasons: "Spring, Summer, Fall, Winter" },
                details: "Region: Mountains, Forests, Plains | Climate: Common, Forest, Hills, Swamp, Grasslands, Mountain, Coastal, Underwater | Notable:",
                fieldGuide: {
                  flora: [
                    { name: "Mandrake Root", description: "This tan root has serrated edges all along its body that often cause injury to Herbalists that do not properly know how to handle it. When stripped of its outer skin, the soft tender center can be eaten with relative ease and is often used by doctors to reduce pain from poison or disease.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Quicksilver Lichen", description: "This silver and grey silky moss can be found growing amongst almost any substance as it seems to ignore environmental standards. Assassins have been able to use this lichen to quickly administer their toxins into the target's system without any drawbacks. However, this takes some preparation and is often forgotten by common folk.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Wild Sageroot", description: "The most common ingredient found among doctors and healer's equipment would be these light pink roots. They measure about 3 to 5 inches in length and have a smooth, fuzzy texture to them. They are used every day by skilled Alchemists and healers to create concoctions of extraordinary healing power.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Bloodgrass", description: "The most boring, common plant life found in the wild is this dark brown grass. It has absolutely no remarkable qualities, other than being relatively harmless, and its use as basic sustenance when properly prepared. Herbalists do not find this grass very unique, but still tend to collect it as it occupies almost no space in their packs.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Wyrmtongue Petals", description: "The assassins, and many Drows, favorite natural ingredient. These jagged red petals can be found growing on Wyrmtongue flowers in almost every terrain. It's almost as if the world itself is trying to test humanity by letting these flowers grow everywhere. These petals are used as a base for toxins that can offer extremely powerful damage. For this reason, Wyrmtongue is highly illegal, and in many cases punishes owners of this flower with death.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Milkweed Seeds", description: "These small, white translucent seeds can be found when opening up a Milkweed Flower. They are often eaten by children due to their friendly look, but can cause negative digestive effects this way. When crushed up and diluted with other liquid these seeds offer very powerful healing effects.", rarity: "Common", habitat: "Most Terrain" },
                    { name: "Hydrathistle", description: "Named for its appearance, this three-pronged blue and black flower is often found in dark and dank environments. When used alone, the thistle has no real beneficial effects. However, skilled alchemists have been able to use highly powerful and natural water to concoct potions that allow them to breathe in water.", rarity: "Uncommon", habitat: "Coastal, Underwater, Swamp" },
                    { name: "Amanita Cap", description: "This large mushroom is often found growing in clusters near bodies of water, or around other damp terrain. It has a bold blue stem accompanied by a large red cap, which makes this fungi extremely easy to identify. Professional herbalists often cut the head from the root, as the mushroom has the rare ability to re-grow its cap within a few short weeks.", rarity: "Common", habitat: "Coastal" },
                    { name: "Hyancinth Nectar", description: "This blue and white thick liquid can be extracted from the Hyancinth's near somewhat wet areas. This nectar is of high demand and is often used by highly trained guards to counter poisons that evil people attempt to use on them. While it does not cure the mean of poisons, it severely limits its effects.", rarity: "Common", habitat: "Coastal, Grasslands" },
                    { name: "Chromus Slime", description: "This thin slime substance is often observed to flow within water current as if it had a mind of its own. Often times, scientists mistake this slime with mercury, as it has the same consistency and look. When attempting to alter the slime, it reverberates and alters the other plant life it touches instead.", rarity: "Rare", habitat: "Coastal, Underdark" },
                    { name: "Lavender Sprig", description: "These long stemmed purple-petal flowers can often be found swaying in the wind in huge patches. They are very common amongst green environments and have a distinct sweet smell. However, they taste extremely bitter when eaten.", rarity: "Common", habitat: "Coastal, Grasslands, Hills" },
                    { name: "Blue Toadshade", description: "Another common mushroom is this dark blue cap with a yellow striped stem. When disturbed, this mushroom lets off a puff of blue powder. Usually this causes no permanent harm to the surrounding creatures, but it can stain their skin and equipment for a short while. The powder is commonly used to color various inks and dyes. Herbalists usually search for the fungi around small watering holes, where aquatic life often thrives.", rarity: "Rare", habitat: "Coastal, Forest, Swamp" },
                    { name: "Wrackwort Bulbs", description: "These huge white bulbs can be found on small yellow mushrooms often found in swamps or wet caverns. The mushroom releases a puff of powder from these bulbs when threatened and it tends to confuse and hinder a person. When harvested successfully, these bulbs can be ground into a paste and imbibed within magical water to diminish the size of a being.", rarity: "Rare", habitat: "Coastal, Swamp" },
                    { name: "Cosmos Glond", description: "This uncommon four-leafed plant is notorious for being somewhat difficult to find. This is mostly due to the plant growing about 5 feet underneath the ground, and only peeking out during its final maturity. However, it has an uncanny look of the stars in a night sky amongst its leaves.", rarity: "Rare", habitat: "Coastal, Desert" },
                    { name: "Harrada Leaf", description: "This huge yellow leaf can often be found near tree tops in lush environments. It is often cultivated and harvested by gangs or the Thieves Guilds to be sold as a street drug. The potent nature of this addictive substance will cause a brief euphoric state coupled with an increase in a specific attribute; followed by a long recovery period in which the user is extremely weakened in that attribute.", rarity: "Common", habitat: "Forest, Grasslands, Hills" },
                    { name: "Nightshade Berries", description: "These light blue berries can be found in small clumped packs among small bushes in lush environments. They can be safely ingested and are often eaten by wild animals for their sweet, but tangy flavor. A skilled Herbalist can enhance the berries natural ability to affect a persons body.", rarity: "Uncommon", habitat: "Forest, Hills" },
                    { name: "Emetic Wax", description: "This thick, white wax is often found seeping out of trees near lush and wet areas. It is commonly used in candle making, as the wax melts and re-hardens rather quickly, yet is strong enough to form delicate shapes. Herbalists use it to control how their tonics enter the body, performing miraculous feats.", rarity: "Common", habitat: "Forest, Swamp" },
                    { name: "Verdant Nettle", description: "With its dark green and yellow speckled mesh, this plant can be easily spotted. It normally grows in forests and can catch a person's feet when traveling if they do not have proper footing. Alchemists like to use this plant to create tonics that enhance one's strength and reflexes.", rarity: "Uncommon", habitat: "Forest" },
                    { name: "Arrow Root", description: "This unusually elongated plant can stand up to four feet tall, and is very easy to spot due to its distinctive white and brown speckled pattern. The Arrow Root thrives in desert and drought environments, as the plant needs very little water to survive. When diced and boiled in water the plant creates a frothy silver liquid, which is ideal for sharpening and polishing weapons and armor without the use of magic or other means.", rarity: "Uncommon", habitat: "Desert, Forest, Grasslands" },
                    { name: "Ironwood Heart", description: "This gnarled white seed is commonly found in the nooks of Ironwood Trees. These large seeds pulse with a slow repetitive beat when gripped tightly, often referred to as “Nature's Heartbeat”. It is said that when cooked or properly prepared by a Herbalist these seeds can increase a beings physical size greatly.", rarity: "Uncommon", habitat: "Arctic, Forest, Hills" },
                    { name: "Wisp Stalks", description: "This incredibly rare fungi has become something of a fable amongst herbalists. It is reported to have a large bulbous cap growing atop a thin stem, and to normally form in small clusters deep within damp cave environments and forests. The organism is usually a translucent blue, and is rumored to render creatures invisible once consumed.", rarity: "Very Rare", habitat: "Forest, Underdark" },
                    { name: "Drakus Flower", description: "This bright red and pale green flower can be found in both temperate and warm environments. It's a natural favorite amongst entertainers, due to the petal's ability to ignite with a moderate application of friction. This ignition does not cause harm, but instead creates theatrical sparks with the ability to light fires and create warmth.", rarity: "Common", habitat: "Desert, Grasslands, Mountain" },
                    { name: "Scillia Beans", description: "These light brown beans can occasionally be found hanging from Scillia Bushes in dry atmosphere environments. They are often used to enhance flavors in stew and other meals, but have a much stranger effect. At full potency, some of these beans can offer the user the ability to climb steep cliffs and rock faces with ease.", rarity: "Common", habitat: "Desert, Grasslands" },
                    { name: "Cactus Juice", description: "This usually clear liquid can be found within most cacti around the world. It's reasonably difficult to extract, as many cacti are dangerous to work with. Brewers love to use this juice in many recipes, as one of its effects is to delay alcohol intoxication, allowing people to purchase and consume more before it hits them.", rarity: "Common", habitat: "Desert, Grasslands" },
                    { name: "Tail Leaf", description: "This very fuzzy, dark green leaf looks like a circle with three thick strands hanging from it. When held, the leaf itself feels as though it is vibrating. It is known that a skilled Herbalist can use these leaves in concoctions to create powerful magical effects to enhance one's speed.", rarity: "Very Rare", habitat: "Grasslands, Hills" },
                    { name: "Devil's Bloodleaf", description: "Only a few recorded instances of this red and yellow flower exist. This large and bold red leaf can be going back in history to the dawn of humankind. It was once a popular decoration around homes and gardens, but has become one of the rarest plants in the world. It is said to give immense vitality and health to one who can properly prepare the plant.", rarity: "Very Rare", habitat: "Hills, Swamp, Underdark" },
                    { name: "Gengko Brush", description: "This low, fan-leafed shrub with ash-green fronds veined in sickly yellow grows in rocky hillsides and the lightless caverns of the Underdark, where it clings to stone with wiry roots. Gengko Brush is prized by alchemists and scouts alike for the resin coating its leaves, which releases a bitter vapor when crushed that sharpens focus and briefly heightens awareness in darkness. The effect fades quickly, but overuse leaves a lingering numbness in the hands and a metallic taste on the tongue.", rarity: "Uncommon", habitat: "Hills, Underdark" },
                    { name: "Rock Vine", description: "This extremely hardened dark green vine can be found growing in the ground near very old minerals, often seeming to feed off the minerals themselves. At first glance this vine seems completely useless to mortals, but arcane studies have shown this vine to harden a person's skin significantly if combined with a powerful catalyst.", rarity: "Rare", habitat: "Hills, Mountain" },
                    { name: "Basilisk's Breath", description: "Often referred to as Grey Restraints amongst the nobles of the world, this dark grey vine is only rarely found atop the highest peaks of mountainous regions. It is fabled that this vine is a gift from the gods, as a way to test humanity. Often sold for outrageous sums of gold, Basilisk's Breath can attract unwanted attention to those trying to sell it for profit.", rarity: "Very Rare", habitat: "Mountain" },
                    { name: "Frozen Seedlings", description: "These small, pea sized pods can be found amongst resilient flowers in very cold environments. Named for their almost frozen appearance, they can be plucked with relative ease and are often used in cold alcoholic drinks. Some assassins have found ways to crush these into a paste and hamper one's movements.", rarity: "Rare", habitat: "Arctic, Mountain" },
                    { name: "Arctic Creeper", description: "This noxious weed usually grows in extremely cold environments, or at higher elevations where snow tends to accumulate. The leaves of the plant characterized by a pleasant sweet minty flavor, whereas the root is bitter and acidic. The weed is one of an assassin's favorite plants, due to the root's ability to freeze a creature's bloodstream, which leads to a slow and agonizing death. The Arctic Creeper is toxic to many unwary travelers, as it is quite easy to consume the root's toxins while enjoying the sweet flavorsome leaves.", rarity: "Common", habitat: "Arctic, Mountain" },
                    { name: "Dried Ephedra", description: "A bush often found in dry environments, it is thorny and hard to harvest without scratching your skin. It has a distinct dark purple hue when viewed at a distance, but up close it looks black. Herbalists love to use this plant when making healing tonics as it has the odd ability to enhance Wild Sageroot.", rarity: "Uncommon", habitat: "Desert, Mountain" },
                    { name: "Luminous Cap Dust", description: "This powder can be shook from the glowing yellow mushrooms often found in extremely dark environments and it keeps an ember-like glow for about a week after extracted. Many Herbalists keep the glowing mushrooms themselves in dark cellars in order to harvest this dust every chance they can.", rarity: "Rare", habitat: "Mountain, Underdark" },
                    { name: "Primordial Balm", description: "This thick substance has been observed changing its coloring, almost at will. The balm is unusually warm to the touch, and can seem to retain heat for weeks on end. Herbalists often find this substance growing on rocks in humid environments. The exact rarity of the substance is unknown, as its constantly changing appearance makes it difficult to identify.", rarity: "Rare", habitat: "Mountain, Swamp, Underdark" },
                    { name: "Spineflower Berries", description: "harvested and crushed to enhance toxins made by scoundrels. However, this effect only applies when introduced directly to the bloodstream. When ingested normally these berries provide little sustenance, but do not harm the person.", rarity: "Uncommon", habitat: "Desert, Swamp" }
                  ],
                  fauna: [
                    { name: "Your Mom", description: "Big ol' thang", rarity: "Common", habitat: "My crib" }
                  ]
                }
              }
            ],
            'sirens-song': [
              {
                id: 1,
                name: "Falkana",
                x: 86,
                y: 33,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "A small fishing town formed along the coastline of Umestris Bay - an inlet of the Northern Sea. Falkana is the northernmost point of civilization on Siren's Song.",
                cityMap: 'sirens_song_maps/falkana.jpeg',
                cityMapNight: 'sirens_song_maps/falkana_night.png', 
                cityLocations: [
                  { name: "Merchant Square", x: 50, y: 30 },
                  { name: "Harbor", x: 40, y: 50 },
                  { name: "Lighthouse", x: 56, y: 60 },
                  { name: "Residential", x: 34, y: 78 },
                  { name: "Vineyard", x: 84, y: 80 }
                ],
                knownNPCs: [
                  { name: "Old Man Theodormus", title: "Cartographer (Human)", importance: "high" },
                  { name: "Marigold Breeves", title: "Fishmonger (Human)", importance: "low" }
                ],
                history: "Falkana has long been a remote cultural isolate of not only Siren's Song, but Issolas as a whole. Though it has few inhabitants, many of the people who live there have known each other for generations. The town had thrived in peace for hundreds of years, but as of late, anomalous and violent events have begun to occur...",
                population: { total: "200", races: "Human, Elf", density: "Sparse" },
                climate: { type: "Coastal, Forest", temperature: "Mild year-round", precipitation: "Moderate rainfall", seasons: "Spring, Summer, Fall, Winter" },
                details: "Population: 200 | NPCs: Theodormus Dawnscry, Marigold Breeves | Notable: First Visited Location"
              },
              {
                id: 2,
                name: "Mount Beala",
                x: 20,
                y: 41,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "An enormous igneous extrusion of rock with strange weather at the summit. Mount Beala is geothermally active but exhibits no geological evidence of eruption.",
                geoMap: "sirens_song_maps/mount_beala.png",
                knownNPCs: [],
                history: "Mount Beala dominates the southern reaches of Siren's Song as an ancient colossus, rising abruptly from the surrounding land. Geological study suggests that Beala did not form through conventional volcanism: there are no calderas, lava flows, ash layers, or vent structures. Instead, the mountain appears to be the result of a massive subterranean upwelling, in which molten rock rose slowly and solidified in place, lifting and deforming the crust without ever breaking it.",
                population: { total: "Unknown", races: "Elementals", density: "Unknown" },
                climate: { type: "Mountain", temperature: "Cold, snow-capped peak", precipitation: "Heavy snowfall at elevation", seasons: "Spring, Winter" },
                details: "Geological Classification: Batholith | Geological Activity: Unknown | Age of Formation: Unknown"
              },
              {
                id: 3,
                name: "Artil",
                x: 27,
                y: 86,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "A large port town with multiple districts centered around fishing trades. Artil is the southernmost point of civilization on Siren's Song and bears the only port on the island, located at the mouth of the Sirenic River delta.",
                cityMap: 'sirens_song_maps/artil.jpg', 
                cityMapNight: 'sirens_song_maps/artil_night.jpg',
                cityLocations: [
                  { name: "Cathedral", x: 33, y: 56 },
                  { name: "The Siren's Song", x: 49, y: 44 },
                  { name: "Town Square", x: 49, y: 30 },
                  { name: "Port District", x: 70, y: 57 },
                  { name: "Academic District", x: 19, y: 55 },
                  { name: "Residential District", x: 24, y: 29 },
                  { name: "Shipyard", x: 50, y: 81 },
                  { name: "Smithy", x: 35, y: 73 }
                ],
                knownNPCs: [
                  { name: "Cassian Dawnscry", title: "Captain (Human)", importance: "high" },
                  { name: "Lady Syva Marina", title: "High Priestess (Human, Cleric)", importance: "high" },
                  { name: "Lord Antioch Diwalen", title: "Usurper High Priest (Human)", importance: "high" },
                  { name: "Lazuli Brynn", title: "Innkeeper, Puzzler (Dwarf)", importance: "medium" },
                  { name: "Amethyst Brynn", title: "Innkeeper (Dwarf)", importance: "low" },
                  { name: "Yorlan Reinholt", title: "Fisherman (Elf)", importance: "low" },
                  { name: "Vigos Ashbourne", title: "Cook (Half-orc)", importance: "low" }
                ],
                history: "Artil began as a seasonal fishing camp founded by coastal clans who followed the great silver shoals that gathered each year where the Sirenic River met the sea. Its natural harbor, formed by the river's branching delta, made it the safest landing on the southern coast of Siren's Song, and temporary huts soon gave way to wharves, smokehouses, and cobblestone docks.",
                population: { total: "2000", races: "Native: Humans, Elves, Dwarves, Halflings", density: "Dense port town" },
                climate: { type: "Coastal Temperate", temperature: "Mild with ocean breezes", precipitation: "Frequent light rain", seasons: "Spring, Summer, Fall, Winter" },
                details: "Population: 2000 | NPCs: Cassian Dawnscry, Lazuli Brynn, Lady Syva Marina | Notable: Only port on Siren's Song"
              }
            ],
            'miligos': [
              {
                id: 1,
                name: "Port Milibra",
                x: 18,
                y: 50,
                description: "Pending description.",
                cityMap: 'miligos_maps/port_milibra.jpg', 
                cityMapNight: 'miligos_maps/port_milibra_night.jpg',
                knownNPCs: [
                  { name: "NPC Name", title: "Title/Role", importance: "high" },
                  { name: "NPC Name", title: "Title/Role", importance: "medium" }
                ],
                history: "Pending historical information.",
                population: { total: "8000", races: "Native: Human, Half-orc, Half-elf, Dwarf, Gnome, Triton", density: "Extremely dense port city" },
                climate: { type: "Coastal", temperature: "Pending", precipitation: "Frequent rain", seasons: "Spring, Summer, Fall, Winter" },
                details: "Population: 8000 | Trade Hub: Major | Notable: Gateway to the east"
              }
            ]
          };

          const isWorldOverview = currentMap === 'world-overview';

          const dungeonsByMap = {
            'sirens-song': [
              {
                id: 'd1',
                name: "The Bunker",
                x: 55,
                y: 35,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "A large, spherical structure buried in the Falkan forest, composed impossibly of organic tissue. Within the organism lay a misted corona of white phosphorescense outlining thick, fiberous vines. The vines lace together to form a latticework script: a kind of dark, incomprehensible sermon with its branching fragments sharing an affinity with that purpose. The script, written in abyssal, was not decipherable through the skill of your party.",
                geoMap: 'sirens_song_maps/dungeons/bunker.png',
                knownNPCs: [],
                history: "From Theodormus: 'I found the bunker in a place just before the forest became waterlogged and turned to salt marsh, surrounded by a fringe of scrub grass, half-hidden by fallen moss off to the left of the trail: an oblate spheroid of some grayish stone seeming a mix of hard sediment and ground-up seashells. It measured roughly 50 feet in diameter, this circular block, and was raised from ground level by about a foot. Its surface remained clean of etchings or writings that could in any way identify its origin or purpose.'",
                climate: { type: "Forest, Swamp", temperature: "Cool and damp"},
                details: "Dungeon Type: Living organism | Danger Level: Medium | Notable: Gulthias seeds, Dark Sermon"
              },
              {
                id: 'd2',
                name: "Volcanic Cave",
                x: 27,
                y: 38,
                roles: ['dm', 'adventurer'],
                fieldGuideRoles: ['dm'],
                description: "Presenting as a dark opening carved into the base of a volanic outcrop, its entrance is jagged and foreboding, framed by blackened rocks that glisten with moisture. The cave seems alive in its own way. The rocks around it bear scars of ancient eruptions - lava flow frozen mid-motion, veins of obsidian gleaming like shards of glass. From below comes a faint vibration, subtle but undeniable, as if the earth itself is breathing just below the surface. The cave is treacherous, inhospitable, and largely uncharted.",
                geoMap: 'sirens_song_maps/dungeons/volcanic_cave.png',
                knownNPCs: [],
                history: "Unknown.",
                climate: { type: "Mountain", temperature: "Extremely hot and dry"},
                details: "Dungeon Type: Mountain cave | Danger Level: High | Notable: Cloak of Fire Walking"
              }
            ],
            'miligos': [
            ]
          };

          // Filter locations and dungeons by role
          const allLocations = locationsByMap[currentMap] || [];
          const locations = allLocations.filter(loc => !loc.roles || loc.roles.includes(userRole));
          
          const allDungeons = dungeonsByMap[currentMap] || [];
          const dungeons = allDungeons.filter(dng => !dng.roles || dng.roles.includes(userRole));

          return (
            <div className="w-full min-h-screen bg-gradient-to-br from-amber-50 via-stone-100 to-amber-100">
              <style>{`
                @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
                
                .parchment-bg {
                  background-image: linear-gradient(rgba(245, 236, 215, 0.9), rgba(239, 227, 203, 0.9)),
                    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 115, 85, 0.03) 2px, rgba(139, 115, 85, 0.03) 4px),
                    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139, 115, 85, 0.03) 2px, rgba(139, 115, 85, 0.03) 4px);
                  box-shadow: inset 0 2px 20px rgba(139, 115, 85, 0.2), 0 8px 30px rgba(0, 0, 0, 0.15);
                }
                .map-container {
                  position: relative;
                  border: 4px solid #8b7355;
                  box-shadow: 0 0 0 2px #d4af37, 0 0 0 6px #8b7355, 0 20px 60px rgba(0, 0, 0, 0.4);
                  display: inline-block;
                }
                .location-node { 
                  animation: nodeAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
                  opacity: 0; transform: translate(-50%, -50%) scale(0);
                }
                .location-node:hover { transform: translate(-50%, -50%) scale(1.2) !important; }
                .dungeon-node { 
                  animation: nodeAppear 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
                  opacity: 0; transform: translate(-50%, -50%) scale(0);
                }
                .dungeon-node:hover { transform: translate(-50%, -50%) scale(1.2) !important; }
                @keyframes nodeAppear {
                  from { opacity: 0; transform: translate(-50%, -50%) scale(0); }
                  to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
                .pulse-ring { animation: pulseRing 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
                .pulse-ring-dungeon { animation: pulseRingDungeon 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
                @keyframes pulseRing {
                  0%, 100% { opacity: 1; transform: scale(1); }
                  50% { opacity: 0; transform: scale(1.8); }
                }
                @keyframes pulseRingDungeon {
                  0%, 100% { opacity: 1; transform: scale(1); }
                  50% { opacity: 0; transform: scale(1.8); }
                }
                .modal-enter { animation: modalEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
                @keyframes modalEnter {
                  from { opacity: 0; transform: scale(0.8) translateY(20px); }
                  to { opacity: 1; transform: scale(1) translateY(0); }
                }
                .ornate-border { border-image: linear-gradient(45deg, #8b7355, #d4af37, #8b7355) 1; border-width: 3px; border-style: solid; }
                .modal-enter::-webkit-scrollbar { width: 12px; }
                .modal-enter::-webkit-scrollbar-track { background: transparent; border-radius: 10px; }
                .modal-enter::-webkit-scrollbar-thumb { background: rgba(139, 115, 85, 0.6); border-radius: 10px; }
                .modal-enter::-webkit-scrollbar-thumb:hover { background: rgba(139, 115, 85, 0.8); }
                *::-webkit-scrollbar { width: 10px; }
                *::-webkit-scrollbar-track { background: transparent; }
                *::-webkit-scrollbar-thumb { background: rgba(139, 115, 85, 0.5); border-radius: 10px; }
                *::-webkit-scrollbar-thumb:hover { background: rgba(139, 115, 85, 0.7); }
                .text-shadow-gold { text-shadow: 2px 2px 4px rgba(212, 175, 55, 0.3); }
                .sidebar {
                  width: 280px; position: fixed; left: 0; top: 0; height: 100vh;
                  background: linear-gradient(135deg, #2d1810 0%, #4a2c1a 100%);
                  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.5); overflow-y: auto; z-index: 100;
                }
                .sidebar-header {
                  background: linear-gradient(135deg, #d4af37 0%, #8b7355 100%);
                  padding: 1.5rem 1rem; text-align: center; border-bottom: 3px solid #d4af37;
                  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                }
                .sidebar-category {
                  padding: 1rem 1.5rem 0.5rem; font-family: 'Cinzel', serif; font-size: 0.75rem;
                  font-weight: 600; color: #d4af37; text-transform: uppercase; letter-spacing: 1px; margin-top: 1rem;
                }
                .sidebar-item {
                  padding: 0.875rem 1.5rem; cursor: pointer; transition: all 0.3s ease;
                  border-left: 3px solid transparent; font-family: 'Crimson Text', serif;
                  font-size: 1.1rem; color: #f5e6d7;
                }
                .sidebar-item:hover { background: rgba(212, 175, 55, 0.15); border-left-color: #d4af37; padding-left: 2rem; }
                .sidebar-item.active { background: rgba(212, 175, 55, 0.25); border-left-color: #d4af37; color: #d4af37; font-weight: 600; }
                .main-content { margin-left: 280px; transition: margin-left 0.3s ease; min-height: 100vh; background: transparent; }
                .tab-button {
                  padding: 0.875rem 1.5rem; cursor: pointer; transition: all 0.3s ease;
                  border-left: 3px solid transparent; font-family: 'Cinzel', serif;
                  font-size: 1.1rem; color: #f5e6d7; font-weight: 600;
                }
                .tab-button:hover { background: rgba(212, 175, 55, 0.15); border-left-color: #d4af37; padding-left: 2rem; }
                .tab-button.active { background: rgba(212, 175, 55, 0.25); border-left-color: #d4af37; color: #d4af37; }
                .content-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
                .codex-section {
                  background: rgba(245, 236, 215, 0.5); border: 2px solid #8b7355; border-radius: 0.5rem;
                  padding: 1.5rem; margin-bottom: 1.5rem; opacity: 0; animation: fadeInScale 0.5s ease-out forwards;
                }
                .codex-section:nth-child(1) { animation-delay: 0.1s; }
                .codex-section:nth-child(2) { animation-delay: 0.2s; }
                .codex-section:nth-child(3) { animation-delay: 0.3s; }
                @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
                .codex-section:hover { transform: scale(1.02); box-shadow: 0 8px 20px rgba(139, 115, 85, 0.3); transition: all 0.3s ease; }
                .editor-toolbar {
                  background: rgba(139, 115, 85, 0.1); border: 2px solid #8b7355; border-radius: 0.5rem 0.5rem 0 0;
                  padding: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: nowrap; align-items: center;
                  justify-content: center; overflow-x: auto;
                }
                .editor-button {
                  padding: 0.5rem 0.75rem; background: rgba(212, 175, 55, 0.2); border: 1px solid #8b7355;
                  border-radius: 0.25rem; cursor: pointer; transition: all 0.2s; font-family: 'Crimson Text', serif;
                  font-size: 0.9rem; color: #2d1810; white-space: nowrap;
                }
                .editor-button:hover { background: rgba(212, 175, 55, 0.4); transform: translateY(-1px); }
                .editor-select {
                  padding: 0.5rem; background: rgba(245, 236, 215, 0.9); border: 1px solid #8b7355;
                  border-radius: 0.25rem; font-family: 'Crimson Text', serif; color: #2d1810; cursor: pointer; font-size: 0.85rem;
                }
                .editor-content {
                  min-height: 400px; max-height: 600px; padding: 1.5rem; background: rgba(245, 236, 215, 0.9);
                  border: 3px solid #8b7355; border-top: none; border-radius: 0 0 0.5rem 0.5rem;
                  font-family: 'Crimson Text', serif; font-size: 1.1rem; color: #2d1810; outline: none; overflow-y: auto;
                }
                .editor-content:focus { border-color: #d4af37; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
                .editor-content ul, .editor-content ol { margin: 0; padding-left: 0; }
                .editor-content li { margin-left: 2.5em; padding-left: 0.5em; }
                .search-highlight { background: rgba(212, 175, 55, 0.5); color: #2d1810; padding: 0 2px; border-radius: 2px; }
                .note-card {
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  padding: 1.5rem; cursor: pointer; transition: all 0.3s; position: relative;
                  break-inside: avoid; margin-bottom: 1.5rem;
                }
                .note-card:hover { box-shadow: 0 8px 20px rgba(139, 115, 85, 0.3); border-color: #d4af37; }
                .note-card.drag-over { border-color: #d4af37; border-style: dashed; transform: scale(1.02); }
                .note-card.dragging { opacity: 0.5; }
                .note-grid { column-count: 3; column-gap: 1.5rem; margin-top: 1.5rem; }
                @media (max-width: 1400px) { .note-grid { column-count: 2; } }
                @media (max-width: 900px) { .note-grid { column-count: 1; } }
                .note-content { font-family: 'Crimson Text', serif; font-size: 1rem; color: #2d1810; line-height: 1.6; }
                .note-content h1, .note-content h2, .note-content h3 { font-family: 'Cinzel', serif; color: #8b5a00; margin: 1rem 0 0.5rem; }
                .note-content h1 { font-size: 1.5rem; }
                .note-content h2 { font-size: 1.25rem; }
                .note-content h3 { font-size: 1.1rem; }
                .note-content p { margin-bottom: 0.75rem; }
                .note-content ul, .note-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
                .note-content li { margin-bottom: 0.25rem; }
                .note-content code { background: rgba(139, 115, 85, 0.15); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.9em; }
                .note-content pre { background: rgba(45, 24, 16, 0.9); color: #f5e6d7; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; }
                .note-content pre code { background: none; padding: 0; color: inherit; }
                .note-content blockquote { border-left: 3px solid #d4af37; padding-left: 1rem; margin: 0.75rem 0; color: #5a4a3a; font-style: italic; }
                .note-content a { color: #8b5a00; text-decoration: underline; }
                .note-content table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
                .note-content th, .note-content td { border: 1px solid #8b7355; padding: 0.5rem; text-align: left; }
                .note-content th { background: rgba(212, 175, 55, 0.2); }
                .note-actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #8b7355; flex-wrap: wrap; }
                .note-card.dragging { opacity: 0.5; transform: scale(0.98); }
                .note-card.drag-over { border-color: #d4af37; border-style: dashed; background: rgba(212, 175, 55, 0.1); }
                .note-search {
                  flex: 1; padding: 0.75rem 1rem; font-family: 'Crimson Text', serif; font-size: 1rem;
                  background: transparent; border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; max-width: 300px;
                }
                .note-search:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
                .note-search-container { display: flex; gap: 1rem; align-items: center; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
                .note-toolbar-button {
                  padding: 0.75rem 1.5rem; background: rgba(212, 175, 55, 0.3); border: 2px solid #d4af37;
                  border-radius: 0.5rem; cursor: pointer; font-family: 'Cinzel', serif; font-size: 1rem;
                  color: #2d1810; transition: all 0.3s; font-weight: 600; white-space: nowrap;
                }
                .note-toolbar-button:hover { background: rgba(212, 175, 55, 0.5); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4); }
                .note-sort-select {
                  padding: 0.75rem 1rem; font-family: 'Crimson Text', serif; font-size: 1rem;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; cursor: pointer;
                }
                .note-sort-select:focus { outline: none; border-color: #d4af37; }
                .expanded-note-overlay {
                  position: fixed; top: 0; left: 280px; right: 0; bottom: 0; 
                  background: rgba(0, 0, 0, 0.85); z-index: 200; 
                  display: flex; align-items: center; justify-content: center; padding: 2rem;
                  animation: fadeIn 0.2s ease;
                }
                .expanded-note-container {
                  background: rgba(245, 236, 215, 0.98); max-width: 900px; width: 100%;
                  max-height: calc(100vh - 4rem); overflow: hidden; position: relative;
                  border: 3px solid #8b7355; border-radius: 0.5rem;
                  box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
                  animation: narrativeEnter 0.3s ease;
                  display: flex; flex-direction: column;
                }
                .expanded-note-header {
                  display: flex; justify-content: space-between; align-items: flex-start;
                  padding: 1.5rem 2rem; border-bottom: 2px solid #8b7355; flex-shrink: 0;
                }
                .expanded-note-title { font-family: 'Cinzel', serif; font-size: 2rem; font-weight: 700; color: #2d1810; margin: 0; }
                .expanded-note-close {
                  width: 40px; height: 40px; background: rgba(139, 115, 85, 0.2); border: 2px solid #8b7355;
                  border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
                  transition: all 0.3s; color: #2d1810; flex-shrink: 0;
                }
                .expanded-note-close:hover { background: rgba(212, 175, 55, 0.4); border-color: #d4af37; transform: scale(1.1); }
                .expanded-note-content { 
                  padding: 2rem; font-family: 'Crimson Text', serif; font-size: 1.15rem; 
                  color: #2d1810; line-height: 1.8; overflow-y: auto; flex: 1;
                }
                .expanded-note-content h1, .expanded-note-content h2, .expanded-note-content h3 { font-family: 'Cinzel', serif; color: #8b5a00; }
                .expanded-note-content h1 { font-size: 1.75rem; }
                .expanded-note-content h2 { font-size: 1.5rem; }
                .expanded-note-content h3 { font-size: 1.25rem; }
                .expanded-note-content code { background: rgba(139, 115, 85, 0.2); padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
                .expanded-note-content pre { background: rgba(45, 24, 16, 0.9); color: #f5e6d7; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
                .expanded-note-content pre code { background: none; color: inherit; }
                .expanded-note-content blockquote { border-left: 3px solid #d4af37; padding-left: 1rem; color: #5a4a3a; font-style: italic; background: rgba(212, 175, 55, 0.1); padding: 0.5rem 1rem; margin: 0.75rem 0; }
                .expanded-note-content a { color: #8b5a00; }
                .expanded-note-content table { width: 100%; border-collapse: collapse; }
                .expanded-note-content th, .expanded-note-content td { border: 1px solid #8b7355; padding: 0.5rem; }
                .expanded-note-content th { background: rgba(212, 175, 55, 0.2); }
                .expanded-note-actions { 
                  display: flex; gap: 1rem; justify-content: center; 
                  padding: 1rem 2rem; border-top: 2px solid #8b7355; flex-shrink: 0;
                }
                .editor-shortcuts {
                  font-family: 'Crimson Text', serif; font-size: 0.8rem; color: #8b7355;
                  margin-top: 0.5rem; text-align: center;
                }
                .markdown-editor-container { margin-bottom: 1rem; }
                .markdown-editor-container .EasyMDEContainer { border: 2px solid #8b7355; border-radius: 0.5rem; overflow: hidden; }
                .markdown-editor-container .EasyMDEContainer .CodeMirror { 
                  background: rgba(245, 236, 215, 0.95); font-family: 'Crimson Text', serif; font-size: 1.1rem; color: #2d1810;
                  border: none; border-radius: 0; min-height: 300px;
                }
                .markdown-editor-container .editor-toolbar { background: rgba(139, 115, 85, 0.15); border-bottom: 2px solid #8b7355; }
                .markdown-editor-container .editor-toolbar button { color: #2d1810 !important; }
                .markdown-editor-container .editor-toolbar button:hover { background: rgba(212, 175, 55, 0.3) !important; }
                .markdown-editor-container .editor-toolbar button.active { background: rgba(212, 175, 55, 0.4) !important; }
                .markdown-editor-container .editor-preview { 
                  background: rgba(245, 236, 215, 0.95); font-family: 'Crimson Text', serif; 
                  padding: 1rem; color: #2d1810;
                }
                .markdown-editor-container .editor-preview h1, 
                .markdown-editor-container .editor-preview h2, 
                .markdown-editor-container .editor-preview h3,
                .markdown-editor-container .editor-preview h4,
                .markdown-editor-container .editor-preview h5,
                .markdown-editor-container .editor-preview h6 { font-family: 'Cinzel', serif; color: #8b5a00; margin: 1rem 0 0.5rem; }
                .markdown-editor-container .editor-preview h1 { font-size: 2rem; }
                .markdown-editor-container .editor-preview h2 { font-size: 1.5rem; }
                .markdown-editor-container .editor-preview h3 { font-size: 1.25rem; }
                .markdown-editor-container .editor-preview p { margin: 0.5rem 0; line-height: 1.6; }
                .markdown-editor-container .editor-preview ul, 
                .markdown-editor-container .editor-preview ol { 
                  margin: 0.5rem 0; padding-left: 1.5rem; 
                }
                .markdown-editor-container .editor-preview ul { list-style-type: disc; }
                .markdown-editor-container .editor-preview ol { list-style-type: decimal; }
                .markdown-editor-container .editor-preview ul ul { list-style-type: circle; }
                .markdown-editor-container .editor-preview ul ul ul { list-style-type: square; }
                .markdown-editor-container .editor-preview li { margin: 0.25rem 0; line-height: 1.5; }
                .markdown-editor-container .editor-preview li > ul,
                .markdown-editor-container .editor-preview li > ol { margin: 0.25rem 0; }
                .markdown-editor-container .editor-preview blockquote { 
                  border-left: 3px solid #d4af37; padding-left: 1rem; margin: 0.5rem 0;
                  color: #5a4a3a; font-style: italic; background: rgba(212, 175, 55, 0.1); padding: 0.5rem 1rem;
                }
                .markdown-editor-container .editor-preview code { 
                  background: rgba(139, 115, 85, 0.15); padding: 0.125rem 0.375rem; border-radius: 0.25rem;
                  font-family: 'Courier New', monospace; font-size: 0.9em;
                }
                .markdown-editor-container .editor-preview pre { 
                  background: rgba(45, 24, 16, 0.9); color: #f5e6d7; padding: 1rem; border-radius: 0.5rem;
                  overflow-x: auto; margin: 0.5rem 0;
                }
                .markdown-editor-container .editor-preview pre code { 
                  background: none; padding: 0; color: inherit; 
                }
                .markdown-editor-container .editor-preview table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; }
                .markdown-editor-container .editor-preview th, 
                .markdown-editor-container .editor-preview td { border: 1px solid #8b7355; padding: 0.5rem; }
                .markdown-editor-container .editor-preview th { background: rgba(212, 175, 55, 0.2); font-weight: 600; }
                .markdown-editor-container .editor-preview hr { border: none; border-top: 2px solid #8b7355; margin: 1rem 0; }
                .markdown-editor-container .editor-preview a { color: #8b5a00; text-decoration: underline; }
                .markdown-editor-container .editor-preview a:hover { color: #d4af37; }
                .markdown-editor-container .editor-preview img { max-width: 100%; height: auto; border-radius: 0.25rem; }
                .markdown-editor-container .editor-preview strong { font-weight: 700; }
                .markdown-editor-container .editor-preview em { font-style: italic; }
                .markdown-editor-container .editor-preview s, 
                .markdown-editor-container .editor-preview del { text-decoration: line-through; }
                .markdown-editor-container .editor-preview input[type="checkbox"] { margin-right: 0.5rem; }
                .markdown-editor-container .CodeMirror-cursor { border-left-color: #2d1810; }
                .markdown-editor-container .EasyMDEContainer .editor-preview-side { 
                  border-left: 2px solid #8b7355; background: rgba(245, 236, 215, 0.95);
                }
                .markdown-editor-container .EasyMDEContainer .editor-preview-active-side {
                  background: rgba(245, 236, 215, 0.95);
                }
                .markdown-editor-container .editor-statusbar { background: rgba(139, 115, 85, 0.1); border-top: 1px solid #8b7355; }
                .markdown-editor-container .editor-statusbar span { color: #5a4a3a; font-family: 'Crimson Text', serif; }
                .auto-save-indicator { font-family: 'Crimson Text', serif; font-size: 0.85rem; color: #8b7355; font-style: italic; }
                .auto-save-indicator.saved { color: #6b8b5a; }
                .action-button {
                  padding: 0.5rem 1rem; border: 1px solid #8b7355; border-radius: 0.25rem;
                  cursor: pointer; transition: all 0.2s; font-family: 'Crimson Text', serif; font-size: 0.9rem;
                }
                .action-button.primary { background: rgba(212, 175, 55, 0.3); color: #2d1810; }
                .action-button.danger { background: rgba(180, 60, 60, 0.2); color: #8b3333; }
                .action-button:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); }
                .new-note-button {
                  padding: 1rem 2rem; background: rgba(212, 175, 55, 0.3); border: 2px solid #d4af37;
                  border-radius: 0.5rem; cursor: pointer; font-family: 'Cinzel', serif; font-size: 1.1rem;
                  color: #2d1810; transition: all 0.3s; font-weight: 600;
                }
                .new-note-button:hover { background: rgba(212, 175, 55, 0.5); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4); }
                .note-title-input {
                  width: 100%; padding: 0.75rem; font-family: 'Cinzel', serif; font-size: 1.5rem;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; margin-bottom: 1rem;
                }
                .note-title-input:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
                .folder-sidebar {
                  width: 250px; background: rgba(139, 115, 85, 0.1); border-right: 2px solid #8b7355;
                  padding: 1rem; overflow-y: auto; max-height: calc(100vh - 2rem);
                }
                .folder-item {
                  padding: 0.75rem 1rem; margin-bottom: 0.5rem; background: rgba(245, 236, 215, 0.5);
                  border: 2px solid #8b7355; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;
                  display: flex; align-items: center; gap: 0.5rem;
                }
                .folder-item:hover { background: rgba(212, 175, 55, 0.3); transform: translateX(4px); }
                .folder-item.active { background: rgba(212, 175, 55, 0.4); border-color: #d4af37; }
                .folder-item.drag-over { background: rgba(212, 175, 55, 0.6); border-color: #d4af37; border-style: dashed; }
                .folder-color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
                .folder-name { flex: 1; font-family: 'Crimson Text', serif; font-size: 1rem; color: #2d1810; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
                .folder-delete {
                  padding: 0.25rem 0.5rem; background: rgba(180, 60, 60, 0.2); border: 1px solid #8b3333;
                  border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; color: #8b3333; opacity: 0; transition: opacity 0.2s;
                }
                .folder-item:hover .folder-delete { opacity: 1; }
                .folder-create {
                  padding: 0.75rem; background: rgba(212, 175, 55, 0.2); border: 2px dashed #8b7355;
                  border-radius: 0.5rem; cursor: pointer; text-align: center; font-family: 'Cinzel', serif;
                  color: #2d1810; transition: all 0.3s;
                }
                .folder-create:hover { background: rgba(212, 175, 55, 0.3); border-color: #d4af37; }
                .folder-input {
                  width: 100%; padding: 0.5rem; font-family: 'Crimson Text', serif;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.25rem;
                  color: #2d1810; margin-bottom: 0.5rem;
                }
                .folder-input:focus { outline: none; border-color: #d4af37; }
                .folder-rename-input {
                  flex: 1; padding: 0.25rem 0.5rem; font-family: 'Crimson Text', serif;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #d4af37; border-radius: 0.25rem;
                  color: #2d1810; font-size: 1rem;
                }
                .folder-rename-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.3); }
                .time-toggle {
                  display: flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem;
                  background: rgba(139, 115, 85, 0.2); border: 2px solid #8b7355; border-radius: 1.5rem;
                  margin-bottom: 0.75rem; justify-content: center;
                }
                .time-slider {
                  position: relative; width: 40px; height: 20px;
                  background: linear-gradient(to right, #4a5568, #1a202c); border-radius: 10px;
                  cursor: pointer; transition: all 0.3s; border: 2px solid #8b7355;
                }
                .time-slider.day { background: linear-gradient(to right, #fbbf24, #f59e0b); }
                .time-slider-thumb {
                  position: absolute; top: 1px; left: 1px; width: 14px; height: 14px;
                  background: white; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                }
                .time-slider.day .time-slider-thumb { transform: translateX(20px); }
                .time-label { font-family: 'Cinzel', serif; font-size: 0.7rem; color: #2d1810; font-weight: 600; min-width: 32px; text-align: center; }
                .catalog-content { flex: 1; padding: 0 2rem; overflow-y: auto; }
                .note-card.dragging { opacity: 0.5; cursor: move; }
                .field-guide-tabs { display: flex; gap: 0; margin-bottom: 1rem; }
                .field-guide-tab {
                  flex: 1; padding: 0.75rem 1rem; background: rgba(139, 115, 85, 0.2);
                  border: 2px solid #8b7355; cursor: pointer; font-family: 'Cinzel', serif;
                  font-size: 1rem; font-weight: 600; color: #2d1810; text-align: center; transition: all 0.3s;
                }
                .field-guide-tab:first-child { border-radius: 0.5rem 0 0 0.5rem; border-right: none; }
                .field-guide-tab:last-child { border-radius: 0 0.5rem 0.5rem 0; }
                .field-guide-tab:hover { background: rgba(212, 175, 55, 0.3); }
                .field-guide-tab.active { background: rgba(212, 175, 55, 0.5); border-color: #d4af37; color: #8b5a00; }
                .field-guide-scroll-container { padding-right: 0.75rem; overflow-y: auto; flex: 1; }
                .field-guide-search-container { 
                  display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;
                }
                .field-guide-search {
                  flex: 1; min-width: 150px; padding: 0.5rem 0.75rem; font-family: 'Crimson Text', serif; font-size: 0.9rem;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810;
                }
                .field-guide-search:focus { outline: none; border-color: #d4af37; }
                .field-guide-filter {
                  padding: 0.5rem 0.75rem; font-family: 'Crimson Text', serif; font-size: 0.85rem;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; cursor: pointer;
                }
                .field-guide-filter:focus { outline: none; border-color: #d4af37; }
                .field-guide-entry {
                  background: rgba(245, 236, 215, 0.6); border-radius: 0.5rem;
                  padding: 1rem; margin-bottom: 0.75rem; transition: all 0.3s;
                }
                .field-guide-entry.rarity-common { border: 2px solid #4a6741; }
                .field-guide-entry.rarity-uncommon { border: 2px solid #2563eb; }
                .field-guide-entry.rarity-rare { border: 2px solid #9333ea; }
                .field-guide-entry.rarity-very-rare { border: 2px solid #ea580c; }
                .field-guide-entry:hover { transform: translateX(4px); box-shadow: 0 4px 12px rgba(139, 115, 85, 0.2); }
                .field-guide-entry.rarity-common:hover { border-color: #6b8b5a; }
                .field-guide-entry.rarity-uncommon:hover { border-color: #3b82f6; }
                .field-guide-entry.rarity-rare:hover { border-color: #a855f7; }
                .field-guide-entry.rarity-very-rare:hover { border-color: #f97316; }
                .field-guide-entry h4 { font-family: 'Cinzel', serif; font-size: 1.1rem; font-weight: 600; color: #8b5a00; margin-bottom: 0.25rem; }
                .field-guide-header { display: flex; gap: 1rem; align-items: flex-start; }
                .field-guide-info { flex: 1; display: flex; flex-direction: column; }
                .field-guide-image { width: 80px; height: 80px; object-fit: cover; border: 2px solid #8b7355; border-radius: 0.5rem; flex-shrink: 0; }
                .field-guide-separator { height: 1px; background: linear-gradient(to right, transparent, #8b7355, transparent); margin: 0.75rem 0; }
                .field-guide-description { font-family: 'Crimson Text', serif; font-size: 0.95rem; color: #2d1810; line-height: 1.5; }
                .field-guide-meta { display: flex; gap: 1rem; font-family: 'Crimson Text', serif; font-size: 0.85rem; color: #6b5a4a; margin-top: 0.25rem; flex-wrap: wrap; }
                .field-guide-meta span { display: flex; align-items: center; gap: 0.25rem; }
                .rarity-badge {
                  display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.125rem 0.5rem;
                  border-radius: 1rem; font-weight: 600; font-size: 0.8rem;
                }
                .rarity-badge.common { background: rgba(74, 103, 65, 0.15); color: #4a6741; border: 1px solid #4a6741; }
                .rarity-badge.uncommon { background: rgba(37, 99, 235, 0.15); color: #2563eb; border: 1px solid #2563eb; }
                .rarity-badge.rare { background: rgba(147, 51, 234, 0.15); color: #9333ea; border: 1px solid #9333ea; }
                .rarity-badge.very-rare { background: rgba(234, 88, 12, 0.15); color: #ea580c; border: 1px solid #ea580c; }
                .rarity-common { color: #4a6741; }
                .rarity-uncommon { color: #2563eb; }
                .rarity-rare { color: #9333ea; }
                .rarity-very-rare { color: #ea580c; }
                .lore-card {
                  background: rgba(245, 236, 215, 0.8); border: 2px solid #8b7355; border-radius: 0.5rem;
                  padding: 1.5rem; cursor: pointer; transition: all 0.3s; position: relative;
                }
                .lore-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(139, 115, 85, 0.3); border-color: #d4af37; }
                .lore-card h3 { font-family: 'Cinzel', serif; font-size: 1.5rem; font-weight: 600; color: #8b5a00; margin-bottom: 0.5rem; }
                .lore-card p { font-family: 'Crimson Text', serif; font-size: 1rem; color: #5a4a3a; line-height: 1.5; }
                .lore-card::after { content: 'Click to read'; position: absolute; bottom: 0.75rem; right: 1rem; font-family: 'Crimson Text', serif; font-size: 0.8rem; color: #8b7355; font-style: italic; opacity: 0; transition: opacity 0.3s; }
                .lore-card:hover::after { opacity: 1; }
                .lore-narrative-overlay {
                  position: fixed; top: 0; left: 280px; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85);
                  z-index: 200; display: flex; align-items: center; justify-content: center; padding: 2rem;
                  animation: fadeIn 0.3s ease;
                }
                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                .lore-narrative-container {
                  background: linear-gradient(135deg, #f5ecd7 0%, #efe3cb 100%);
                  border: 4px solid #8b7355; border-radius: 0.5rem; max-width: 800px; width: 100%;
                  max-height: calc(100vh - 4rem); overflow: hidden; position: relative;
                  box-shadow: 0 0 0 2px #d4af37, 0 0 60px rgba(0, 0, 0, 0.5);
                  animation: narrativeEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                  display: flex; flex-direction: column;
                }
                @keyframes narrativeEnter { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
                .lore-narrative-header {
                  background: linear-gradient(135deg, #d4af37 0%, #8b7355 100%);
                  padding: 1.5rem 2rem; border-bottom: 3px solid #8b7355; flex-shrink: 0;
                }
                .lore-narrative-header h1 { font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 700; color: #2d1810; text-align: center; margin: 0; }
                .lore-narrative-close {
                  position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px;
                  background: rgba(45, 24, 16, 0.2); border: 2px solid #2d1810; border-radius: 50%;
                  cursor: pointer; display: flex; align-items: center; justify-content: center;
                  transition: all 0.3s; color: #2d1810; z-index: 5;
                }
                .lore-narrative-close:hover { background: rgba(45, 24, 16, 0.4); transform: scale(1.1); }
                .lore-narrative-content {
                  padding: 2rem 3rem 3rem; font-family: 'Crimson Text', serif; font-size: 1.2rem;
                  color: #2d1810; line-height: 2; white-space: pre-wrap;
                  overflow-y: auto; flex: 1;
                }
                .lore-narrative-content p { margin-bottom: 1.5rem; text-indent: 0; }
                .lore-narrative-end { text-align: center; color: #8b7355; font-size: 1.5rem; margin-top: 2rem; }
                .search-highlight { background: rgba(212, 175, 55, 0.5); color: #2d1810; padding: 0 2px; border-radius: 2px; }
                .note-search { 
                  padding: 0.75rem 1rem; font-family: 'Crimson Text', serif; font-size: 1rem;
                  background: transparent; border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; max-width: 300px;
                }
                .note-search:focus { outline: none; border-color: #d4af37; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); }
                .note-search-container { display: flex; gap: 1rem; align-items: center; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap; }
                .note-sort-select {
                  padding: 0.75rem 1rem; font-family: 'Crimson Text', serif; font-size: 1rem;
                  background: rgba(245, 236, 215, 0.9); border: 2px solid #8b7355; border-radius: 0.5rem;
                  color: #2d1810; cursor: pointer;
                }
                .note-sort-select:focus { outline: none; border-color: #d4af37; }
                .note-toolbar-button {
                  padding: 0.75rem 1.5rem; background: rgba(212, 175, 55, 0.3); border: 2px solid #d4af37;
                  border-radius: 0.5rem; cursor: pointer; font-family: 'Cinzel', serif; font-size: 1rem;
                  color: #2d1810; transition: all 0.3s; font-weight: 600; white-space: nowrap;
                }
                .note-toolbar-button:hover { background: rgba(212, 175, 55, 0.5); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4); }
                .note-card.drag-over { border-color: #d4af37; border-style: dashed; background: rgba(212, 175, 55, 0.2); }
                .expanded-note-overlay {
                  position: fixed; top: 0; left: 280px; right: 0; bottom: 0; 
                  background: rgba(0, 0, 0, 0.85); z-index: 200; 
                  display: flex; align-items: center; justify-content: center; padding: 2rem;
                  animation: fadeIn 0.2s ease;
                }
                .expanded-note-container {
                  background: rgba(245, 236, 215, 0.98); max-width: 900px; width: 100%;
                  max-height: calc(100vh - 4rem); overflow-y: auto; position: relative;
                  padding: 2rem; animation: narrativeEnter 0.3s ease;
                  border: 3px solid #8b7355; border-radius: 0.5rem;
                  box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
                }
                .expanded-note-header {
                  display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem;
                  border-bottom: 2px solid #8b7355; padding-bottom: 1rem;
                }
                .expanded-note-title { font-family: 'Cinzel', serif; font-size: 2.5rem; font-weight: 700; color: #2d1810; margin: 0; }
                .expanded-note-close {
                  width: 40px; height: 40px; background: rgba(139, 115, 85, 0.2); border: 2px solid #8b7355;
                  border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
                  transition: all 0.3s; color: #2d1810; flex-shrink: 0; margin-left: 1rem;
                }
                .expanded-note-close:hover { background: rgba(212, 175, 55, 0.4); border-color: #d4af37; transform: scale(1.1); }
                .expanded-note-content { 
                  font-family: 'Crimson Text', serif; font-size: 1.2rem; color: #2d1810; line-height: 1.8;
                }
                .expanded-note-content h1, .expanded-note-content h2, .expanded-note-content h3 { font-family: 'Cinzel', serif; color: #8b5a00; margin: 1rem 0 0.5rem; }
                .expanded-note-content h1 { font-size: 2rem; }
                .expanded-note-content h2 { font-size: 1.5rem; }
                .expanded-note-content h3 { font-size: 1.25rem; }
                .expanded-note-content p { margin: 0.5rem 0; }
                .expanded-note-content ul, .expanded-note-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
                .expanded-note-content ul { list-style-type: disc; }
                .expanded-note-content ol { list-style-type: decimal; }
                .expanded-note-content ul ul { list-style-type: circle; }
                .expanded-note-content ul ul ul { list-style-type: square; }
                .expanded-note-content li { margin: 0.25rem 0; }
                .expanded-note-content code { background: rgba(139, 115, 85, 0.2); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-family: 'Courier New', monospace; font-size: 0.9em; }
                .expanded-note-content pre { background: rgba(45, 24, 16, 0.9); color: #f5e6d7; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5rem 0; }
                .expanded-note-content pre code { background: none; color: inherit; }
                .expanded-note-content blockquote { border-left: 3px solid #d4af37; padding-left: 1rem; color: #5a4a3a; font-style: italic; background: rgba(212, 175, 55, 0.1); padding: 0.5rem 1rem; margin: 0.75rem 0; }
                .expanded-note-content a { color: #8b5a00; text-decoration: underline; }
                .expanded-note-content a:hover { color: #d4af37; }
                .expanded-note-content table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; }
                .expanded-note-content th, .expanded-note-content td { border: 1px solid #8b7355; padding: 0.5rem; }
                .expanded-note-content th { background: rgba(212, 175, 55, 0.2); font-weight: 600; }
                .expanded-note-content hr { border: none; border-top: 2px solid #8b7355; margin: 1rem 0; }
                .expanded-note-content img { max-width: 100%; height: auto; border-radius: 0.25rem; }
                .expanded-note-actions { display: flex; gap: 1rem; margin-top: 2rem; justify-content: center; padding-top: 1rem; border-top: 2px solid #8b7355; }
                .note-content { font-family: 'Crimson Text', serif; font-size: 1rem; color: #2d1810; line-height: 1.6; flex: 1; overflow: hidden; }
                .note-content h1, .note-content h2, .note-content h3 { font-family: 'Cinzel', serif; color: #8b5a00; margin: 0.5rem 0; }
                .note-content h1 { font-size: 1.3rem; }
                .note-content h2 { font-size: 1.15rem; }
                .note-content h3 { font-size: 1rem; }
                .note-content p { margin-bottom: 0.5rem; }
                .note-content ul, .note-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
                .note-content ul { list-style-type: disc; }
                .note-content ol { list-style-type: decimal; }
                .note-content li { margin: 0.25rem 0; }
                .note-content code { background: rgba(139, 115, 85, 0.15); padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.85em; font-family: 'Courier New', monospace; }
                .note-content pre { background: rgba(45, 24, 16, 0.9); color: #f5e6d7; padding: 0.75rem; border-radius: 0.25rem; overflow-x: auto; margin: 0.5rem 0; }
                .note-content pre code { background: none; color: inherit; }
                .note-content blockquote { border-left: 2px solid #d4af37; padding-left: 0.75rem; margin: 0.5rem 0; color: #5a4a3a; font-style: italic; }
                .note-content table { width: 100%; border-collapse: collapse; margin: 0.5rem 0; font-size: 0.9rem; }
                .note-content th, .note-content td { border: 1px solid #8b7355; padding: 0.25rem 0.5rem; }
                .note-content th { background: rgba(212, 175, 55, 0.2); }
                .note-content a { color: #8b5a00; }
                .note-content hr { border: none; border-top: 1px solid #8b7355; margin: 0.5rem 0; }
                .note-content img { max-width: 100%; height: auto; }
                .npc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
                .npc-grid-item { padding: 0.5rem 0.75rem; background: rgba(245, 236, 215, 0.6); border: 1px solid #8b7355; border-radius: 0.25rem; text-align: center; font-family: 'Crimson Text', serif; font-size: 0.95rem; color: #2d1810; }
                .note-folder-select {
                  position: absolute; bottom: 0; left: 100%; background: rgba(245, 236, 215, 0.98);
                  border: 2px solid #8b7355; border-radius: 0.5rem; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                  margin-left: 0.5rem; min-width: 150px; max-height: 250px; overflow-y: auto;
                }
                .note-folder-option {
                  padding: 0.6rem 0.75rem; cursor: pointer; font-family: 'Crimson Text', serif;
                  display: flex; align-items: center; gap: 0.5rem; transition: background 0.2s;
                  white-space: nowrap;
                }
                .note-folder-option:hover { background: rgba(212, 175, 55, 0.3); }
                .note-folder-option:active { background: rgba(212, 175, 55, 0.5); }
                .note-folder-option .folder-color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
                .move-note-btn {
                  padding: 0.4rem 0.6rem; background: rgba(37, 99, 235, 0.2); border: 1px solid #2563eb;
                  border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; color: #2563eb;
                  font-family: 'Crimson Text', serif; display: none; position: relative;
                }
                .move-note-btn:hover { background: rgba(37, 99, 235, 0.3); }
                @media (max-width: 1024px) { .move-note-btn { display: inline-block; } }
                @media (pointer: coarse) { .move-note-btn { display: inline-block; } }
                @media (hover: none) { .move-note-btn { display: inline-block; } }
                @media (max-width: 768px) {
                  .sidebar { transform: translateX(-100%); }
                  .sidebar.mobile-open { transform: translateX(0); }
                  .main-content { margin-left: 0; }
                  .folder-sidebar { width: 200px; }
                  .npc-grid { grid-template-columns: repeat(2, 1fr); }
                  .note-folder-select { 
                    position: fixed; 
                    left: 50%; 
                    top: 50%; 
                    transform: translate(-50%, -50%);
                    margin: 0;
                    min-width: 200px;
                    max-width: 80vw;
                    max-height: 60vh;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                  }
                }
                @media (max-width: 1024px) and (min-width: 769px) {
                  .note-folder-select { 
                    position: fixed; 
                    left: 50%; 
                    top: 50%; 
                    transform: translate(-50%, -50%);
                    margin: 0;
                    min-width: 200px;
                    max-height: 60vh;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
                  }
                }
              `}</style>

              <aside className="sidebar">
                <div className="sidebar-header">
                  <h2 className="text-2xl font-bold text-amber-900" style={{ fontFamily: 'Cinzel, serif' }}>Compendium</h2>
                </div>
                {/* User Info */}
                <div className="px-4 py-3 border-b border-amber-800 bg-gradient-to-r from-amber-900/20 to-transparent">
                  <div className="flex items-center gap-3">
                    {user.photoURL && <img src={user.photoURL} alt="" className="w-8 h-8 rounded-full border-2 border-amber-600" />}
                    <div className="flex-1 min-w-0">
                      <p className="text-amber-200 text-sm truncate" style={{ fontFamily: 'Crimson Text, serif' }}>{user.displayName || user.email}</p>
                      <p className="text-amber-500 text-xs capitalize" style={{ fontFamily: 'Cinzel, serif' }}>{userRole}</p>
                    </div>
                  </div>
                  <button onClick={onLogout} className="mt-2 w-full text-xs text-amber-400 hover:text-amber-200 transition-colors py-1" style={{ fontFamily: 'Crimson Text, serif' }}>Sign Out</button>
                </div>
                <div className={`tab-button ${activeTab === 'cartographer' ? 'active' : ''}`} onClick={() => { closeAllModals(); setActiveTab('cartographer'); }}>Cartographer</div>
                <div className={`tab-button ${activeTab === 'codex' ? 'active' : ''}`} onClick={() => { closeAllModals(); setActiveTab('codex'); }}>Codex</div>
                <div className={`tab-button ${activeTab === 'catalog' ? 'active' : ''}`} onClick={() => { closeAllModals(); setActiveTab('catalog'); }}>Catalog</div>

                {activeTab === 'cartographer' && (
                  <>
                    <div className="sidebar-category">Issolas</div>
                    {visibleMapRegions.filter(region => region.category === 'Issolas').map(region => (
                      <div key={region.id} className={`sidebar-item ${currentMap === region.id ? 'active' : ''}`}
                        onClick={() => { setCurrentMap(region.id); setSelectedLocation(null); }}>
                        {region.name}
                      </div>
                    ))}
                  </>
                )}
                {activeTab === 'codex' && (
                  <>
                    <div className="sidebar-category">Sections</div>
                    <div className={`sidebar-item ${activeCodexSection === 'lore' ? 'active' : ''}`} onClick={() => setActiveCodexSection('lore')}>Lore</div>
                    <div className={`sidebar-item ${activeCodexSection === 'pantheon' ? 'active' : ''}`} onClick={() => setActiveCodexSection('pantheon')}>Pantheon</div>
                  </>
                )}
              </aside>

              <div className="main-content p-4">
                {activeTab === 'cartographer' && (
                  <div className="w-full h-[calc(100vh-2rem)] flex justify-center items-center">
                    <div className="map-container rounded-lg overflow-hidden inline-block max-w-full max-h-[calc(100vh-2rem)]">
                      <img src={getMapImage(activeMapData)} alt={`${activeMapData.name} Map`}
                        className="block w-auto h-auto max-w-full max-h-[calc(100vh-2rem)] object-contain" style={{ display: 'block' }} />
                      <div className="absolute inset-0 pointer-events-none"></div>
                      {nodesVisible && locations.map((location, index) => (
                        <div key={location.id} className="absolute location-node cursor-pointer pointer-events-auto"
                          style={{ left: `${location.x}%`, top: `${location.y}%`, animationDelay: `${index * 0.15}s` }}
                          onClick={() => { setSelectedLocation(location); setActiveFieldGuideTab('flora'); }}
                          onMouseEnter={() => setHoveredNode(location.id)} onMouseLeave={() => setHoveredNode(null)}>
                          {hoveredNode === location.id && (
                            <div className="absolute inset-0 pulse-ring"><div className="w-12 h-12 rounded-full border-4 border-amber-600 opacity-50"></div></div>
                          )}
                          <div className="relative">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-amber-600 to-amber-800 border-4 border-amber-200 shadow-lg flex items-center justify-center">
                              <MapPin className="w-6 h-6 text-amber-50" />
                            </div>
                            {hoveredNode === location.id && (
                              <div className="absolute top-full mt-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                                <div className="bg-amber-900 text-amber-50 px-3 py-1 rounded shadow-lg text-sm" style={{ fontFamily: 'Cinzel, serif' }}>{location.name}</div>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                      {nodesVisible && !isWorldOverview && dungeons.map((dungeon, index) => (
                        <div key={dungeon.id} className="absolute dungeon-node cursor-pointer pointer-events-auto"
                          style={{ left: `${dungeon.x}%`, top: `${dungeon.y}%`, animationDelay: `${(locations.length + index) * 0.15}s` }}
                          onClick={() => { setSelectedLocation(dungeon); setActiveFieldGuideTab('flora'); }}
                          onMouseEnter={() => setHoveredNode(dungeon.id)} onMouseLeave={() => setHoveredNode(null)}>
                          {hoveredNode === dungeon.id && (
                            <div className="absolute inset-0 pulse-ring-dungeon"><div className="w-12 h-12 rounded-full border-4 border-slate-500 opacity-50"></div></div>
                          )}
                          <div className="relative">
                            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-slate-500 to-slate-700 border-4 border-slate-300 shadow-lg flex items-center justify-center">
                              <Skull className="w-6 h-6 text-slate-100" />
                            </div>
                            {hoveredNode === dungeon.id && (
                              <div className="absolute top-full mt-2 left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                                <div className="bg-slate-800 text-slate-100 px-3 py-1 rounded shadow-lg text-sm" style={{ fontFamily: 'Cinzel, serif' }}>{dungeon.name}</div>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {activeTab === 'codex' && (
                  <div className="overflow-y-auto h-[calc(100vh-2rem)]" style={{ paddingRight: '1rem' }}>
                    <div className="content-container">
                    <h1 className="text-5xl font-bold text-amber-900 mb-8 text-center text-shadow-gold" style={{ fontFamily: 'Cinzel, serif' }}>
                      {activeCodexSection === 'lore' ? 'Lore' : 'Pantheon'}
                    </h1>
                    {activeCodexSection === 'lore' && (
                      <div className="max-w-4xl mx-auto grid gap-6">
                        {codexData.lore.map((entry, index) => (
                          <div key={index} className="lore-card" onClick={() => setSelectedLore(entry)}>
                            <h3>{entry.title}</h3>
                            <p>{entry.summary}</p>
                          </div>
                        ))}
                      </div>
                    )}
                    {activeCodexSection === 'pantheon' && (
                      <div className="max-w-6xl mx-auto">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                          {/* The Six Column */}
                          <div>
                            <h2 className="text-3xl font-bold text-amber-900 mb-6 text-center" style={{ fontFamily: 'Cinzel, serif' }}>The Six</h2>
                            {codexData.pantheon.theSix.map((deity, index) => (
                              <div key={index} className="codex-section">
                                <div className="flex gap-4 mb-3" style={{ minHeight: '120px' }}>
                                  <div className="flex-1 flex flex-col justify-between">
                                    <div>
                                      <h3 className="text-2xl font-bold text-amber-900 mb-1" style={{ fontFamily: 'Cinzel, serif' }}>{deity.name}</h3>
                                      <h4 className="text-lg text-amber-800 mb-2 italic" style={{ fontFamily: 'Crimson Text, serif' }}>{deity.title}</h4>
                                    </div>
                                    <div className="text-sm text-amber-800" style={{ fontFamily: 'Crimson Text, serif' }}>
                                      <p><strong>Domains:</strong> {deity.domains}</p>
                                      <p><strong>Symbol:</strong> {deity.symbol}</p>
                                    </div>
                                  </div>
                                  {deity.image && (
                                    <div className="flex-shrink-0">
                                      <img src={deity.image} alt={deity.name} className="w-28 h-28 object-cover rounded-lg border-2 border-amber-700" />
                                    </div>
                                  )}
                                </div>
                                <div className="h-px bg-gradient-to-r from-amber-600 via-amber-400 to-amber-600 mb-3"></div>
                                <p className="text-amber-950 leading-relaxed" style={{ fontFamily: 'Crimson Text, serif', fontSize: '0.95rem' }}>{deity.description}</p>
                              </div>
                            ))}
                          </div>
                          {/* Lesser Gods Column */}
                          <div>
                            <h2 className="text-3xl font-bold text-amber-900 mb-6 text-center" style={{ fontFamily: 'Cinzel, serif' }}>Lesser Gods</h2>
                            {codexData.pantheon.lesserGods.map((deity, index) => (
                              <div key={index} className="codex-section">
                                <div className="flex gap-4 mb-3" style={{ minHeight: '120px' }}>
                                  <div className="flex-1 flex flex-col justify-between">
                                    <div>
                                      <h3 className="text-2xl font-bold text-amber-900 mb-1" style={{ fontFamily: 'Cinzel, serif' }}>{deity.name}</h3>
                                      <h4 className="text-lg text-amber-800 mb-2 italic" style={{ fontFamily: 'Crimson Text, serif' }}>{deity.title}</h4>
                                    </div>
                                    <div className="text-sm text-amber-800" style={{ fontFamily: 'Crimson Text, serif' }}>
                                      <p><strong>Domains:</strong> {deity.domains}</p>
                                      <p><strong>Symbol:</strong> {deity.symbol}</p>
                                    </div>
                                  </div>
                                  {deity.image && (
                                    <div className="flex-shrink-0">
                                      <img src={deity.image} alt={deity.name} className="w-28 h-28 object-cover rounded-lg border-2 border-amber-700" />
                                    </div>
                                  )}
                                </div>
                                <div className="h-px bg-gradient-to-r from-amber-600 via-amber-400 to-amber-600 mb-3"></div>
                                <p className="text-amber-950 leading-relaxed" style={{ fontFamily: 'Crimson Text, serif', fontSize: '0.95rem' }}>{deity.description}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}
                    </div>
                  </div>
                )}

                {activeTab === 'catalog' && (
                  <div className="flex h-[calc(100vh-2rem)]">
                    <div className="folder-sidebar">
                      <h2 className="text-xl font-bold text-amber-900 mb-4 text-center" style={{ fontFamily: 'Cinzel, serif' }}>Folders</h2>
                      <div className={`folder-item ${selectedFolder === null ? 'active' : ''}`} onClick={() => setSelectedFolder(null)}>
                        <div className="folder-color-dot" style={{ background: '#8b7355' }}></div>
                        <span className="folder-name">All Notes</span>
                      </div>
                      {folders.map((folder) => (
                        <div key={folder.id} className={`folder-item ${selectedFolder === folder.id ? 'active' : ''}`}
                          onClick={() => { if (editingFolderId !== folder.id) setSelectedFolder(folder.id); }}
                          onDoubleClick={() => { setEditingFolderId(folder.id); setEditingFolderName(folder.name); }}
                          onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }}
                          onDragLeave={(e) => { e.currentTarget.classList.remove('drag-over'); }}
                          onDrop={(e) => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if (draggedNote) { moveNoteToFolder(draggedNote, folder.id); setDraggedNote(null); } }}>
                          <div className="folder-color-dot" style={{ background: folder.color }}></div>
                          {editingFolderId === folder.id ? (
                            <input type="text" className="folder-rename-input" value={editingFolderName}
                              onChange={(e) => setEditingFolderName(e.target.value)}
                              onBlur={() => renameFolder(folder.id, editingFolderName)}
                              onKeyPress={(e) => { if (e.key === 'Enter') renameFolder(folder.id, editingFolderName); }}
                              onClick={(e) => e.stopPropagation()} autoFocus />
                          ) : (
                            <span className="folder-name">{folder.name}</span>
                          )}
                          <button type="button" className="folder-delete" onClick={(e) => { e.stopPropagation(); deleteFolder(folder.id); }}>×</button>
                        </div>
                      ))}
                      {!isCreatingFolder && <div className="folder-create" onClick={() => setIsCreatingFolder(true)}>+ New Folder</div>}
                      {isCreatingFolder && (
                        <div style={{ marginTop: '1rem' }}>
                          <input type="text" className="folder-input" placeholder="Folder name..." value={newFolderName}
                            onChange={(e) => setNewFolderName(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && createFolder()} />
                          <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', marginBottom: '0.5rem' }}>
                            <input type="color" value={newFolderColor} onChange={(e) => setNewFolderColor(e.target.value)}
                              style={{ width: '40px', height: '30px', cursor: 'pointer', border: '2px solid #8b7355', borderRadius: '0.25rem' }} />
                            <span style={{ fontFamily: 'Crimson Text, serif', fontSize: '0.9rem', color: '#2d1810' }}>Color</span>
                          </div>
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button className="action-button primary" onClick={createFolder} style={{ flex: 1, padding: '0.5rem' }}>Create</button>
                            <button className="action-button" onClick={() => { setIsCreatingFolder(false); setNewFolderName(''); setNewFolderColor('#d4af37'); }}
                              style={{ flex: 1, padding: '0.5rem', background: 'rgba(139, 115, 85, 0.2)' }}>Cancel</button>
                          </div>
                        </div>
                      )}
                    </div>
                    <div className="catalog-content">
                      <h1 className="text-5xl font-bold text-amber-900 mb-4 text-center text-shadow-gold" style={{ fontFamily: 'Cinzel, serif' }}>Catalog</h1>
                      <p className="text-center text-amber-800 mb-6" style={{ fontFamily: 'Crimson Text, serif' }}>Your notes are synced to the cloud.</p>
                      {notesLoading ? (
                        <div className="text-center py-8">
                          <div className="animate-spin rounded-full h-8 w-8 border-2 border-amber-300 border-t-amber-600 mx-auto mb-2"></div>
                          <p className="text-amber-700" style={{ fontFamily: 'Crimson Text, serif' }}>Loading notes...</p>
                        </div>
                      ) : (<>
                      {!isCreatingNote && (
                        <div className="note-search-container">
                          <input 
                            type="text" 
                            className="note-search" 
                            placeholder="Search" 
                            value={noteSearchQuery}
                            onChange={(e) => setNoteSearchQuery(e.target.value)}
                          />
                          <select 
                            className="note-sort-select" 
                            value={noteSortOrder} 
                            onChange={(e) => setNoteSortOrder(e.target.value)}
                          >
                            <option value="manual">Manual Order</option>
                            <option value="alphabetical">Alphabetical</option>
                            <option value="lastEdited">Last Edited</option>
                          </select>
                          <button className="note-toolbar-button" onClick={createNewNote}>+ New Note</button>
                        </div>
                      )}
                      {isCreatingNote && (
                        <div className="mb-8" key={editingNoteId || 'new'}>
                          <input type="text" className="note-title-input" placeholder="Note Title..." value={currentNote.title}
                            onChange={(e) => {
                              const newTitle = e.target.value;
                              setCurrentNote({...currentNote, title: newTitle});
                              if (editingNoteId) {
                                scheduleAutoSave(newTitle, currentNote.content, currentNote.folderId);
                              }
                            }} />
                          <div className="markdown-editor-container">
                            <textarea ref={editorContainerRef}></textarea>
                          </div>
                          <div className="editor-shortcuts">
                            <strong>Shortcuts:</strong> Cmd/Ctrl+B Bold | Cmd/Ctrl+I Italic | Cmd/Ctrl+H Heading | Cmd/Ctrl+L List | Cmd/Ctrl+' Quote | Cmd/Ctrl+P Preview
                          </div>
                          <div className="flex gap-4 mt-4 items-center">
                            <button className="action-button primary" onClick={saveNote} style={{ flex: 1, padding: '0.75rem' }}>{editingNoteId ? 'Done' : 'Save Note'}</button>
                            <button className="action-button" onClick={() => { setIsCreatingNote(false); setCurrentNote({ title: '', content: '', folderId: null }); setEditingNoteId(null); setAutoSaveStatus(null); }}
                              style={{ flex: 1, padding: '0.75rem', background: 'rgba(139, 115, 85, 0.2)' }}>Cancel</button>
                            {editingNoteId && autoSaveStatus === 'saving' && <span className="auto-save-indicator">Saving...</span>}
                            {editingNoteId && autoSaveStatus === 'saved' && <span className="auto-save-indicator saved">Saved</span>}
                          </div>
                        </div>
                      )}
                      <div className="note-grid">
                        {!isCreatingNote && sortedNotes.map((note, index) => (
                          <div 
                            key={note.id} 
                            className={`note-card ${draggedNote === note.id ? 'dragging' : ''} ${dragOverNoteId === note.id ? 'drag-over' : ''}`}
                            onClick={() => setExpandedNote(note)}
                            draggable
                            onDragStart={(e) => { e.stopPropagation(); setDraggedNote(note.id); }} 
                            onDragEnd={() => { setDraggedNote(null); setDragOverNoteId(null); }}
                            onDragOver={(e) => handleNoteDragOver(e, note.id)}
                            onDragLeave={() => setDragOverNoteId(null)}
                            onDrop={(e) => handleNoteDrop(e, note.id)}
                          >
                            <h3 
                              className="text-2xl font-bold text-amber-900 mb-3" 
                              style={{ fontFamily: 'Cinzel, serif' }}
                              dangerouslySetInnerHTML={{ __html: highlightSearchMatch(note.title || 'Untitled Note') }}
                            ></h3>
                            <div className="note-content" dangerouslySetInnerHTML={{ __html: highlightSearchMatch(renderMarkdown(note.content), true) }}></div>
                            <div className="note-actions" onClick={(e) => e.stopPropagation()} style={{ position: 'relative' }}>
                              <button type="button" className="action-button primary" onClick={(e) => { e.stopPropagation(); editNote(note); }}>Edit</button>
                              <button type="button" className="action-button danger" onClick={(e) => { e.stopPropagation(); deleteNote(note.id); }}>Delete</button>
                              <button type="button" className="move-note-btn" onClick={(e) => { e.stopPropagation(); setMovingNoteId(movingNoteId === note.id ? null : note.id); }}>Move</button>
                              {movingNoteId === note.id && (
                                <div className="note-folder-select" onClick={(e) => e.stopPropagation()}>
                                  <div className="note-folder-option" onClick={(e) => { e.stopPropagation(); moveNoteToFolder(note.id, null); setMovingNoteId(null); }}>
                                    <div className="folder-color-dot" style={{ background: '#8b7355' }}></div>
                                    <span>No Folder</span>
                                  </div>
                                  {folders.map(folder => (
                                    <div key={folder.id} className="note-folder-option" onClick={(e) => { e.stopPropagation(); moveNoteToFolder(note.id, folder.id); setMovingNoteId(null); }}>
                                      <div className="folder-color-dot" style={{ background: folder.color }}></div>
                                      <span>{folder.name}</span>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                      {sortedNotes.length === 0 && !isCreatingNote && noteSearchQuery && (
                        <div className="text-center text-amber-700 mt-8" style={{ fontFamily: 'Crimson Text, serif', fontSize: '1.2rem' }}>No notes match your search.</div>
                      )}
                      {noteCards.length === 0 && !isCreatingNote && !noteSearchQuery && (
                        <div className="text-center text-amber-700 mt-8" style={{ fontFamily: 'Crimson Text, serif', fontSize: '1.2rem' }}>No notes yet.</div>
                      )}
                      </>)}
                    </div>
                  </div>
                )}
              </div>

              {selectedLocation && (
                <div className="fixed bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"
                  style={{ left: '280px', right: '0', top: '0', bottom: '0' }} onClick={() => setSelectedLocation(null)}>
                  <div className="flex gap-4 w-full modal-enter" style={{ maxWidth: '1400px', maxHeight: 'calc(100vh - 2rem)' }} onClick={(e) => e.stopPropagation()}>
                    {/* Left Panel - Field Guide or City Map */}
                    <div className="parchment-bg rounded-lg p-4 ornate-border overflow-hidden" style={{ width: '50%', display: 'flex', flexDirection: 'column' }}>
                      {isWorldOverview && canAccessFieldGuide(selectedLocation) ? (
                        <>
                          <h3 className="text-2xl font-bold text-amber-900 mb-3 text-center" style={{ fontFamily: 'Cinzel, serif' }}>Field Guide</h3>
                          <div className="field-guide-tabs">
                            <div className={`field-guide-tab ${activeFieldGuideTab === 'flora' ? 'active' : ''}`} onClick={() => { setActiveFieldGuideTab('flora'); setFieldGuideSearch(''); setFieldGuideRarityFilter('all'); setFieldGuideHabitatFilter('all'); }}>Flora</div>
                            <div className={`field-guide-tab ${activeFieldGuideTab === 'fauna' ? 'active' : ''}`} onClick={() => { setActiveFieldGuideTab('fauna'); setFieldGuideSearch(''); setFieldGuideRarityFilter('all'); setFieldGuideHabitatFilter('all'); }}>Fauna</div>
                          </div>
                          {/* Search and Filters */}
                          <div className="field-guide-search-container">
                            <input 
                              type="text" 
                              className="field-guide-search" 
                              placeholder="Search..." 
                              value={fieldGuideSearch}
                              onChange={(e) => setFieldGuideSearch(e.target.value)}
                            />
                            <select 
                              className="field-guide-filter" 
                              value={fieldGuideRarityFilter} 
                              onChange={(e) => setFieldGuideRarityFilter(e.target.value)}
                            >
                              <option value="all">All Rarities</option>
                              <option value="common">Common</option>
                              <option value="uncommon">Uncommon</option>
                              <option value="rare">Rare</option>
                              <option value="very-rare">Very Rare</option>
                            </select>
                            <select 
                              className="field-guide-filter" 
                              value={fieldGuideHabitatFilter} 
                              onChange={(e) => setFieldGuideHabitatFilter(e.target.value)}
                            >
                              <option value="all">All Habitats</option>
                              {selectedLocation.fieldGuide && getUniqueHabitats(selectedLocation.fieldGuide).map(habitat => (
                                <option key={habitat} value={habitat}>{habitat}</option>
                              ))}
                            </select>
                          </div>
                          <div className="field-guide-scroll-container">
                            {selectedLocation.fieldGuide ? (
                              <>
                                {activeFieldGuideTab === 'flora' && selectedLocation.fieldGuide.flora && (
                                  (() => {
                                    const filteredFlora = filterFieldGuideEntries(selectedLocation.fieldGuide.flora);
                                    return filteredFlora.length > 0 ? (
                                      filteredFlora.map((entry, index) => {
                                        const rarityInfo = getRarityInfo(entry.rarity);
                                        const rarityClass = entry.rarity.toLowerCase().replace(' ', '-');
                                        return (
                                          <div key={index} className={`field-guide-entry rarity-${rarityClass}`}>
                                            <div className="field-guide-header">
                                              <div className="field-guide-info">
                                                <h4 dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.name) }}></h4>
                                                <div className="field-guide-meta">
                                                  <span className={`rarity-badge ${rarityClass}`}>
                                                    {rarityInfo.icon} {entry.rarity}
                                                  </span>
                                                  <span dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.habitat) }}></span>
                                                </div>
                                              </div>
                                              {entry.image && <img src={entry.image} alt={entry.name} className="field-guide-image" />}
                                            </div>
                                            <div className="field-guide-separator"></div>
                                            <p className="field-guide-description" dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.description) }}></p>
                                          </div>
                                        );
                                      })
                                    ) : (
                                      <div className="text-center text-amber-700 italic mt-8" style={{ fontFamily: 'Crimson Text, serif' }}>
                                        {fieldGuideSearch || fieldGuideRarityFilter !== 'all' || fieldGuideHabitatFilter !== 'all' 
                                          ? 'No flora entries match your filters.' 
                                          : 'No flora entries yet.'}
                                      </div>
                                    );
                                  })()
                                )}
                                {activeFieldGuideTab === 'fauna' && selectedLocation.fieldGuide.fauna && (
                                  (() => {
                                    const filteredFauna = filterFieldGuideEntries(selectedLocation.fieldGuide.fauna);
                                    return filteredFauna.length > 0 ? (
                                      filteredFauna.map((entry, index) => {
                                        const rarityInfo = getRarityInfo(entry.rarity);
                                        const rarityClass = entry.rarity.toLowerCase().replace(' ', '-');
                                        return (
                                          <div key={index} className={`field-guide-entry rarity-${rarityClass}`}>
                                            <div className="field-guide-header">
                                              <div className="field-guide-info">
                                                <h4 dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.name) }}></h4>
                                                <div className="field-guide-meta">
                                                  <span className={`rarity-badge ${rarityClass}`}>
                                                    {rarityInfo.icon} {entry.rarity}
                                                  </span>
                                                  <span dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.habitat) }}></span>
                                                </div>
                                              </div>
                                              {entry.image && <img src={entry.image} alt={entry.name} className="field-guide-image" />}
                                            </div>
                                            <div className="field-guide-separator"></div>
                                            <p className="field-guide-description" dangerouslySetInnerHTML={{ __html: highlightFieldGuideMatch(entry.description) }}></p>
                                          </div>
                                        );
                                      })
                                    ) : (
                                      <div className="text-center text-amber-700 italic mt-8" style={{ fontFamily: 'Crimson Text, serif' }}>
                                        {fieldGuideSearch || fieldGuideRarityFilter !== 'all' || fieldGuideHabitatFilter !== 'all' 
                                          ? 'No fauna entries match your filters.' 
                                          : 'No fauna entries yet.'}
                                      </div>
                                    );
                                  })()
                                )}
                              </>
                            ) : (
                              <div className="text-center text-amber-700 italic mt-8" style={{ fontFamily: 'Crimson Text, serif' }}>No field guide data available for this region.</div>
                            )}
                          </div>
                        </>
                      ) : isWorldOverview && !canAccessFieldGuide(selectedLocation) ? (
                        <>
                          <div className="flex-1 flex items-center justify-center">
                            <div className="text-center text-amber-700" style={{ fontFamily: 'Crimson Text, serif' }}>
                              <p className="text-lg italic">Missing field guide data for this region.</p>
                            </div>
                          </div>
                        </>
                      ) : (
                        <>
                          <div className="flex-1 flex items-center justify-center mb-4 relative">
                            {selectedLocation.geoMap ? (
                              <div className="relative inline-block max-w-full max-h-full">
                                <img src={selectedLocation.geoMap}
                                  alt={`${selectedLocation.name} Map`} className="max-w-full max-h-full object-contain rounded" style={{ maxHeight: 'calc(100vh - 12rem)' }} />
                              </div>
                            ) : selectedLocation.cityMap || selectedLocation.cityMapNight ? (
                              <div className="relative inline-block max-w-full max-h-full">
                                <img src={mapTimeOfDay === 'day' ? (selectedLocation.cityMap || selectedLocation.cityMapNight) : (selectedLocation.cityMapNight || selectedLocation.cityMap)}
                                  alt={`${selectedLocation.name} City Map`} className="max-w-full max-h-full object-contain rounded" style={{ maxHeight: 'calc(100vh - 18rem)' }} />
                                {selectedLocation.cityLocations && selectedLocation.cityLocations.map((loc, index) => (
                                  <div key={index} className="absolute" style={{ left: `${loc.x}%`, top: `${loc.y}%`, transform: 'translate(-50%, -50%)' }}>
                                    <div className="rounded-full bg-amber-600 border-2 border-amber-200 shadow-lg flex items-center justify-center cursor-pointer hover:scale-110 transition-transform"
                                      style={{ width: '24px', height: '24px', fontFamily: 'Cinzel, serif', fontWeight: 'bold', color: '#fff', fontSize: '0.75rem', lineHeight: '1' }} title={loc.name}>
                                      {index + 1}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="text-center text-amber-700 italic" style={{ fontFamily: 'Crimson Text, serif' }}>No map available</div>
                            )}
                          </div>
                          {!selectedLocation.geoMap && (selectedLocation.cityMap || selectedLocation.cityMapNight) && (
                            <div className="time-toggle">
                              <span className="time-label">Night</span>
                              <div className={`time-slider ${mapTimeOfDay === 'day' ? 'day' : ''}`} onClick={() => setMapTimeOfDay(mapTimeOfDay === 'day' ? 'night' : 'day')}>
                                <div className="time-slider-thumb"></div>
                              </div>
                              <span className="time-label">Day</span>
                            </div>
                          )}
                          {selectedLocation.cityLocations && selectedLocation.cityLocations.length > 0 && (
                            <div className="bg-amber-50 bg-opacity-50 rounded p-3 border-2 border-amber-700">
                              <h3 className="text-base font-bold text-amber-900 mb-2 text-center" style={{ fontFamily: 'Cinzel, serif' }}>Legend</h3>
                              <div className="gap-x-4 gap-y-1" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))' }}>
                                {selectedLocation.cityLocations.map((loc, index) => (
                                  <div key={index} className="flex items-center gap-2">
                                    <div className="rounded-full bg-amber-600 border-2 border-amber-200 flex items-center justify-center flex-shrink-0"
                                      style={{ width: '20px', height: '20px', fontFamily: 'Cinzel, serif', fontWeight: 'bold', color: '#fff', fontSize: '0.7rem', lineHeight: '1' }}>{index + 1}</div>
                                    <span className="text-amber-950 truncate" style={{ fontFamily: 'Crimson Text, serif', fontSize: '0.85rem' }} title={loc.name}>{loc.name}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </>
                      )}
                    </div>

                    {/* Right Panel - Information */}
                    <div className="parchment-bg rounded-lg p-8 ornate-border overflow-y-auto" style={{ width: '50%' }}>
                      <button onClick={() => setSelectedLocation(null)} className="float-right p-2 hover:bg-amber-200 rounded-full transition-colors">
                        <X className="w-6 h-6 text-amber-900" />
                      </button>
                      <h2 className="text-4xl font-bold text-amber-900 mb-4 pr-12 text-shadow-gold" style={{ fontFamily: 'Cinzel, serif' }}>{selectedLocation.name}</h2>
                      <div className="flex items-center gap-3 mb-6">
                        <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                        <div className="text-amber-600">◆</div>
                        <div className="flex-1 h-px bg-gradient-to-r from-transparent via-amber-600 to-transparent"></div>
                      </div>
                      <p className="text-lg text-amber-950 leading-relaxed mb-6" style={{ fontFamily: 'Crimson Text, serif' }}>{selectedLocation.description}</p>

                      {selectedLocation.knownNPCs && selectedLocation.knownNPCs.length > 0 && (
                        <div className="mb-6">
                          <h3 className="text-2xl font-bold text-amber-900 mb-3" style={{ fontFamily: 'Cinzel, serif' }}>Known NPCs</h3>
                          {isWorldOverview ? (
                            <div className="npc-grid">
                              {selectedLocation.knownNPCs.map((npc, index) => (
                                <div key={index} className="npc-grid-item">{npc.name}</div>
                              ))}
                            </div>
                          ) : (
                            <div className="space-y-2">
                              {selectedLocation.knownNPCs.sort((a, b) => {
                                const importanceOrder = { high: 1, medium: 2, low: 3 };
                                return importanceOrder[a.importance] - importanceOrder[b.importance];
                              }).map((npc, index) => (
                                <div key={index} className="flex items-center gap-3 p-2 bg-amber-50 bg-opacity-50 rounded">
                                  <div className={`w-2 h-2 rounded-full ${npc.importance === 'high' ? 'bg-red-600' : npc.importance === 'medium' ? 'bg-yellow-600' : 'bg-green-600'}`}></div>
                                  <div>
                                    <span className="font-semibold text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}>{npc.name}</span>
                                    <span className="text-amber-800 ml-2" style={{ fontFamily: 'Crimson Text, serif' }}>— {npc.title}</span>
                                    {npc.race && (
                                      <span className="text-amber-700 ml-2" style={{ fontFamily: 'Crimson Text, serif' }}>({npc.race}{npc.class ? `, ${npc.class}` : ''})</span>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      )}

                      {selectedLocation.history && (
                        <div className="mb-6">
                          <h3 className="text-2xl font-bold text-amber-900 mb-3" style={{ fontFamily: 'Cinzel, serif' }}>History</h3>
                          <p className="text-lg text-amber-950 leading-relaxed" style={{ fontFamily: 'Crimson Text, serif' }}>{selectedLocation.history}</p>
                        </div>
                      )}

                      {selectedLocation.population && (
                        <div className="mb-6">
                          <h3 className="text-2xl font-bold text-amber-900 mb-3" style={{ fontFamily: 'Cinzel, serif' }}>Population</h3>
                          <div className="bg-amber-50 bg-opacity-50 rounded p-4 space-y-2">
                            <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Total:</strong> {selectedLocation.population.total}</p>
                            <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Native Races:</strong> {selectedLocation.population.races}</p>
                            <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Density:</strong> {selectedLocation.population.density}</p>
                          </div>
                        </div>
                      )}

                      {selectedLocation.climate && (
                        <div className="mb-6">
                          <h3 className="text-2xl font-bold text-amber-900 mb-3" style={{ fontFamily: 'Cinzel, serif' }}>Climate</h3>
                          <div className="bg-amber-50 bg-opacity-50 rounded p-4 space-y-2">
                            <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Type:</strong> {selectedLocation.climate.type}</p>
                            <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Temperature:</strong> {selectedLocation.climate.temperature}</p>
                            {selectedLocation.climate.precipitation && (
                              <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Precipitation:</strong> {selectedLocation.climate.precipitation}</p>
                            )}
                            {selectedLocation.climate.seasons && (
                              <p className="text-amber-950" style={{ fontFamily: 'Crimson Text, serif' }}><strong>Seasons:</strong> {selectedLocation.climate.seasons}</p>
                            )}
                          </div>
                        </div>
                      )}

                      <div className="mt-6 text-center text-amber-600 text-xs">◆</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Lore Narrative Modal */}
              {selectedLore && (
                <div className="lore-narrative-overlay" onClick={() => setSelectedLore(null)}>
                  <div className="lore-narrative-container" onClick={(e) => e.stopPropagation()}>
                    <div className="lore-narrative-header">
                      <h1>{selectedLore.title}</h1>
                      <button className="lore-narrative-close" onClick={() => setSelectedLore(null)}>
                        <X className="w-5 h-5" />
                      </button>
                    </div>
                    <div className="lore-narrative-content">
                      {selectedLore.narrative}
                      <div className="lore-narrative-end">◆ ◆ ◆</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Expanded Note Modal */}
              {expandedNote && (
                <div className="expanded-note-overlay" onClick={() => setExpandedNote(null)}>
                  <div className="expanded-note-container" onClick={(e) => e.stopPropagation()}>
                    <div className="expanded-note-header">
                      <h1 className="expanded-note-title">{expandedNote.title || 'Untitled Note'}</h1>
                      <button className="expanded-note-close" onClick={() => setExpandedNote(null)}>
                        <X className="w-5 h-5" />
                      </button>
                    </div>
                    <div className="expanded-note-content" dangerouslySetInnerHTML={{ __html: renderMarkdown(expandedNote.content) }}></div>
                    <div className="expanded-note-actions">
                      <button type="button" className="action-button primary" onClick={(e) => { e.stopPropagation(); editNote(expandedNote); setExpandedNote(null); }}>Edit</button>
                      <button type="button" className="action-button danger" onClick={(e) => { e.stopPropagation(); deleteNote(expandedNote.id); }}>Delete</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
